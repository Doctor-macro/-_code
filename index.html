<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>VBA Code Share</title>
<style>
  body { font-family: Consolas, monospace; padding: 20px; }
  pre {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
  }
</style>
</head>
<body>
<h2>VBA Code</h2>
<pre><code>



Option Explicit

'=================================================
' 職位→順位の辞書（キャッシュ）
'=================================================
Private gPosRank As Object

'========================
' 共通：結合セル対応
'========================
Private Function GetMergedText(ByVal rng As Range) As String
    If rng Is Nothing Then Exit Function
    If rng.MergeCells Then
        GetMergedText = CStr(rng.MergeArea.Cells(1, 1).Value)
    Else
        GetMergedText = CStr(rng.Value)
    End If
End Function

Private Function NzStr(ByVal v As Variant) As String
    If IsError(v) Or IsEmpty(v) Then
        NzStr = ""
    Else
        NzStr = CStr(v)
    End If
End Function

'========================
' 結合セル左上行判定
'========================
Private Function IsMergeTopLeftRow(ByVal c As Range) As Boolean
    If c.MergeCells Then
        IsMergeTopLeftRow = (c.Row = c.MergeArea.Row And c.Column = c.MergeArea.Column)
    Else
        IsMergeTopLeftRow = True
    End If
End Function

'========================
' 次の書き込み行
'========================
Private Function NextWriteRow(ByVal ws As Worksheet) As Long
    Dim r As Long
    r = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    If r < 4 Then r = 3
    NextWriteRow = r + 1
End Function

'========================
' ヘッダ設定（3行目）
'========================
Private Sub EnsureHeaders(ByVal ws As Worksheet)
    ws.Cells(3, "A").Value = "コード/形態"
    ws.Cells(3, "B").Value = "ファイル名"
    ws.Cells(3, "C").Value = "月"
    ws.Cells(3, "D").Value = "本部"
    ws.Cells(3, "E").Value = "ビジネス・ユニット"
    ws.Cells(3, "F").Value = "部"
    ws.Cells(3, "G").Value = "課"
    ws.Cells(3, "H").Value = "エリア"
    ws.Cells(3, "I").Value = "店舗"
    ws.Cells(3, "J").Value = "従業員番号"
    ws.Cells(3, "K").Value = "氏名"
    ws.Cells(3, "L").Value = "職位"
    ws.Cells(3, "M").Value = "職位順位"
End Sub

'========================
' ファイル名 → 月（◯年◯月）
'========================
Private Function ExtractMonthFromFileName(ByVal s As String) As String
    Dim p As Long
    s = NzStr(s)
    p = InStr(s, "月")
    If p <= 1 Then Exit Function
    ExtractMonthFromFileName = Mid$(s, 2, p - 1)
End Function

Private Sub FillMonthAll(ByVal ws As Worksheet)
    Dim lastR As Long, r As Long
    lastR = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    For r = 4 To lastR
        ws.Cells(r, "C").Value = ExtractMonthFromFileName(ws.Cells(r, "B").Value)
    Next r
End Sub

'=================================================
' 職位順位（職位順位シートから読込）
'   職位順位!A2:A30 = 1..（数字）
'   職位順位!B2:B30 = 職位名（文字列）
'=================================================
Private Function GetPosRankDict() As Object
    If Not gPosRank Is Nothing Then
        Set GetPosRankDict = gPosRank
        Exit Function
    End If

    Dim d As Object
    Set d = CreateObject("Scripting.Dictionary")
    d.CompareMode = vbTextCompare

    Dim ws As Worksheet
    On Error Resume Next
    Set ws = ThisWorkbook.Worksheets("職位順位")
    On Error GoTo 0

    If ws Is Nothing Then
        Set gPosRank = d
        Set GetPosRankDict = gPosRank
        Exit Function
    End If

    Dim r As Long
    For r = 2 To 30
        Dim rankV As Variant, pos As String
        rankV = ws.Cells(r, "A").Value
        pos = Trim$(CStr(ws.Cells(r, "B").Value))

        If pos <> "" And IsNumeric(rankV) Then
            ' 同名が複数あったら先勝ち
            If Not d.Exists(pos) Then d.Add pos, CLng(rankV)
        End If
    Next r

    Set gPosRank = d
    Set GetPosRankDict = gPosRank
End Function

' 職位→順位（シート基準）
Private Function PosRank(ByVal pos As String) As Variant
    Dim p As String
    p = Trim$(CStr(pos))
    If p = "" Then
        PosRank = ""
        Exit Function
    End If

    Dim d As Object
    Set d = GetPosRankDict()

    If d.Exists(p) Then
        PosRank = d(p)
    Else
        PosRank = ""
    End If
End Function

' シート編集後に手動で再読み込みしたい場合
Public Sub 職位順位_再読み込み()
    Set gPosRank = Nothing
    Call GetPosRankDict
    MsgBox "職位順位を再読み込みしました。", vbInformation
End Sub

'========================
' 配属店舗一覧：1行出力
'========================
Private Sub WriteRow( _
    ws As Worksheet, fileName As String, code As String, _
    d1 As String, d2 As String, d3 As String, d4 As String, _
    shop As String, empNo As String, empName As String, pos As String)

    If empNo = "" And empName = "" And pos = "" Then Exit Sub

    Dim r As Long: r = NextWriteRow(ws)
    ws.Cells(r, "A").Value = code
    ws.Cells(r, "B").Value = fileName
    ws.Cells(r, "D").Value = d1
    ws.Cells(r, "F").Value = d2
    ws.Cells(r, "G").Value = d3
    ws.Cells(r, "H").Value = d4
    ws.Cells(r, "I").Value = shop
    ws.Cells(r, "J").Value = empNo
    ws.Cells(r, "K").Value = empName
    ws.Cells(r, "L").Value = pos
    ws.Cells(r, "M").Value = PosRank(pos)
End Sub

'========================
' メイン
'========================
Public Sub 取り込み実行_本社_配属店舗一覧()

    ' ★毎回、職位順位シートの最新を読む
    Set gPosRank = Nothing
    Call GetPosRankDict

    Dim wsOut As Worksheet
    Set wsOut = ActiveSheet
    EnsureHeaders wsOut

    Dim fd As FileDialog
    Set fd = Application.FileDialog(msoFileDialogFilePicker)
    fd.AllowMultiSelect = True
    fd.Filters.Clear
    fd.Filters.Add "Excel", "*.xlsx;*.xlsm;*.xls"
    If fd.Show <> -1 Then Exit Sub

    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual

    Dim i As Long, wb As Workbook
    For i = 1 To fd.SelectedItems.Count
        Set wb = Workbooks.Open(fd.SelectedItems(i), ReadOnly:=True)
        Extract_Honsya wb, wsOut
        Extract_Haisyoku wb, wsOut
        wb.Close False
    Next i

    FillMonthAll wsOut

    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
    MsgBox "取り込み完了"

End Sub

'========================
' 【本社】
'========================
Private Sub Extract_Honsya(ByVal wb As Workbook, ByVal wsOut As Worksheet)

    Dim ws As Worksheet
    On Error Resume Next
    Set ws = wb.Worksheets("本社")
    On Error GoTo 0
    If ws Is Nothing Then Exit Sub

    Dim r As Long, tier As Long, baseCol As Long
    Dim dept(1 To 5) As String
    Dim empNo As String, empName As String, pos As String

    For r = 5 To ws.Cells(ws.Rows.Count, "G").End(xlUp).Row
        For tier = 1 To 5
            baseCol = 7 + (tier - 1) * 5
            dept(tier) = GetMergedText(ws.Cells(r, baseCol + 1))
        Next tier

        For tier = 1 To 5
            baseCol = 7 + (tier - 1) * 5
            empNo = NzStr(ws.Cells(r, baseCol + 3).Value)
            empName = NzStr(ws.Cells(r, baseCol + 4).Value)
            pos = NzStr(ws.Cells(r, baseCol + 2).Value)

            If empNo <> "" Or empName <> "" Or pos <> "" Then
                WriteRow wsOut, wb.Name, GetMergedText(ws.Cells(r, "D")), _
                    dept(1), dept(2), dept(3), dept(4), dept(5), _
                    empNo, empName, pos
            End If
        Next tier
    Next r
End Sub

'========================
' 【配属店舗一覧】
'========================
Private Sub Extract_Haisyoku(ByVal wb As Workbook, ByVal wsOut As Worksheet)

    Dim ws As Worksheet
    On Error Resume Next
    Set ws = wb.Worksheets("配属店舗一覧")
    On Error GoTo 0
    If ws Is Nothing Then Exit Sub

    Dim r As Long
    Dim d1 As String, d2 As String, d3 As String, d4 As String
    Dim shop As String, code As String

    For r = 5 To ws.Cells(ws.Rows.Count, "AN").End(xlUp).Row
        d1 = GetMergedText(ws.Cells(r, "Q"))
        d2 = GetMergedText(ws.Cells(r, "W"))
        d3 = GetMergedText(ws.Cells(r, "AC"))
        d4 = GetMergedText(ws.Cells(r, "AI"))
        shop = NzStr(ws.Cells(r, "AO").Value)

        code = Left$(GetMergedText(ws.Cells(r, "B")), 1)

        ' 通常ブロック
        Dim blk As Long
        For blk = 1 To 5
            WriteRow wsOut, wb.Name, code, d1, d2, d3, d4, shop, _
                NzStr(ws.Cells(r, ws.Columns("AT").Column + (blk - 1) * 6).Value), _
                NzStr(ws.Cells(r, ws.Columns("AT").Column + (blk - 1) * 6 + 1).Value), _
                NzStr(ws.Cells(r, ws.Columns("AQ").Column + (blk - 1) * 6).Value)
        Next blk

        ' 役職者（結合セル左上のみ）
        If IsMergeTopLeftRow(ws.Cells(r, "T")) Then _
            WriteRow wsOut, wb.Name, code, d1, "", "", "", "", _
                NzStr(ws.Cells(r, "T").Value), NzStr(ws.Cells(r, "U").Value), "総括部長/本部長"

        If IsMergeTopLeftRow(ws.Cells(r, "Z")) Then _
            WriteRow wsOut, wb.Name, code, d1, d2, "", "", "", _
                NzStr(ws.Cells(r, "Z").Value), NzStr(ws.Cells(r, "AA").Value), "部長/UL"

        If IsMergeTopLeftRow(ws.Cells(r, "AF")) Then _
            WriteRow wsOut, wb.Name, code, d1, d2, d3, "", "", _
                NzStr(ws.Cells(r, "AF").Value), NzStr(ws.Cells(r, "AG").Value), "AMGR/CMGR"

        If IsMergeTopLeftRow(ws.Cells(r, "AL")) Then _
            WriteRow wsOut, wb.Name, code, d1, d2, d3, d4, "", _
                NzStr(ws.Cells(r, "AL").Value), NzStr(ws.Cells(r, "AM").Value), "MGR"
    Next r
End Sub

  


                          
</code></pre>
</body>
</html>
