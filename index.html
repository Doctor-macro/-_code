<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>VBA Code Share</title>
<style>
  body { font-family: Consolas, monospace; padding: 20px; }
  pre {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
  }
</style>
</head>
<body>
<h2>VBA Code</h2>
<pre><code>

Option Explicit

'========================
'  共通：結合セル対応取得
'========================
Private Function GetMergedText(ByVal rng As Range) As String
    If rng Is Nothing Then
        GetMergedText = ""
        Exit Function
    End If

    If rng.MergeCells Then
        GetMergedText = CStr(rng.MergeArea.Cells(1, 1).Value)
    Else
        GetMergedText = CStr(rng.Value)
    End If
End Function

Private Function NzStr(ByVal v As Variant) As String
    If IsError(v) Then
        NzStr = ""
    ElseIf IsEmpty(v) Or v = "" Then
        NzStr = ""
    Else
        NzStr = CStr(v)
    End If
End Function

Private Function NextWriteRow(ByVal wsOut As Worksheet) As Long
    ' 反映ファイル：4行目以降に追記
    Dim lastA As Long
    lastA = wsOut.Cells(wsOut.Rows.Count, "A").End(xlUp).Row
    If lastA < 4 Then
        NextWriteRow = 4
    Else
        NextWriteRow = lastA + 1
    End If
End Function

'=========================================================
'  メイン：複数ファイル選択 → 本社/配属店舗一覧 抽出 → 追記
'=========================================================
Public Sub 取り込み実行_本社_配属店舗一覧()
    Dim wsOut As Worksheet
    Set wsOut = ActiveSheet  ' 出力先は反映ファイルのアクティブシート想定（必要なら固定名に変更）

    Dim fd As FileDialog
    Set fd = Application.FileDialog(msoFileDialogFilePicker)

    With fd
        .Title = "取り込むファイルを複数選択してください"
        .AllowMultiSelect = True
        .Filters.Clear
        .Filters.Add "Excel Files", "*.xlsx;*.xlsm;*.xls"
        If .Show <> -1 Then Exit Sub
    End With

    Dim prevCalc As XlCalculation
    prevCalc = Application.Calculation
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.DisplayAlerts = False
    Application.Calculation = xlCalculationManual

    Dim i As Long, path As String
    Dim wbSrc As Workbook

    On Error GoTo SafeExit

    For i = 1 To fd.SelectedItems.Count
        path = fd.SelectedItems(i)

        Set wbSrc = Workbooks.Open(Filename:=path, ReadOnly:=True)

        ' 本社
        Call Extract_Honsya(wbSrc, wsOut)

        ' 配属店舗一覧
        Call Extract_Haisyoku(wbSrc, wsOut)

        wbSrc.Close SaveChanges:=False
        Set wbSrc = Nothing
    Next i

SafeExit:
    Application.Calculation = prevCalc
    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.ScreenUpdating = True

    If Err.Number <> 0 Then
        MsgBox "エラー: " & Err.Number & vbCrLf & Err.Description, vbExclamation
    Else
        MsgBox "取り込みが完了しました。", vbInformation
    End If
End Sub

'========================
'  【本社】抽出
'========================
Private Sub Extract_Honsya(ByVal wbSrc As Workbook, ByVal wsOut As Worksheet)
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = wbSrc.Worksheets("本社")
    On Error GoTo 0
    If ws Is Nothing Then Exit Sub

    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, "G").End(xlUp).Row
    If lastRow < 5 Then Exit Sub

    Dim r As Long
    Dim fileBase As String
    fileBase = wbSrc.Name

    ' 本社：G～AE（5列×5階層）
    ' 各階層：部門コード, 部門名称, 職位, 社員番号, 氏名
    Dim tier As Long
    Dim baseCol As Long
    Dim deptName(1 To 5) As String
    Dim pos As String, empNo As String, empName As String
    Dim wrote As Boolean

    For r = 5 To lastRow
        ' 階層部門名称を毎行拾う（結合セル対策で GetMergedText）
        For tier = 1 To 5
            baseCol = 7 + (tier - 1) * 5 ' G=7
            deptName(tier) = Trim$(GetMergedText(ws.Cells(r, baseCol + 1))) ' 部門名称
        Next tier

        wrote = False

        ' どこかの階層に(職位/社員番号/氏名)が入っている → その分だけ出力
        For tier = 1 To 5
            baseCol = 7 + (tier - 1) * 5

            pos = Trim$(NzStr(ws.Cells(r, baseCol + 2).Value))    ' 職位
            empNo = Trim$(NzStr(ws.Cells(r, baseCol + 3).Value))  ' 社員番号
            empName = Trim$(NzStr(ws.Cells(r, baseCol + 4).Value))' 氏名

            If (empNo <> "") Or (empName <> "") Or (pos <> "") Then
                Dim outR As Long
                outR = NextWriteRow(wsOut)

                ' 共通
                wsOut.Cells(outR, "A").Value = fileBase
                ' B列は触らない

                ' 本社 指定列
                wsOut.Cells(outR, "C").Value = deptName(1)
                wsOut.Cells(outR, "D").Value = deptName(2)
                wsOut.Cells(outR, "E").Value = deptName(3)
                wsOut.Cells(outR, "F").Value = deptName(4)
                wsOut.Cells(outR, "G").Value = deptName(5)

                wsOut.Cells(outR, "I").Value = empNo
                wsOut.Cells(outR, "J").Value = empName
                wsOut.Cells(outR, "K").Value = pos

                wrote = True
            End If
        Next tier

        ' もし階層部門だけで社員情報が一切ない行はスキップ（必要ならここで出力に変更可能）
        If wrote = False Then
            ' do nothing
        End If
    Next r
End Sub

'========================
'  【配属店舗一覧】抽出
'========================
Private Sub Extract_Haisyoku(ByVal wbSrc As Workbook, ByVal wsOut As Worksheet)
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = wbSrc.Worksheets("配属店舗一覧")
    On Error GoTo 0
    If ws Is Nothing Then Exit Sub

    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, "AN").End(xlUp).Row ' 店舗番号列
    If lastRow < 5 Then Exit Sub

    Dim fileBase As String
    fileBase = wbSrc.Name

    Dim r As Long

    ' 部門名称：Q, W, AC, AI（結合セル）
    ' 店舗名：AO
    ' 1行に複数人：ブロックごとに展開
    '
    ' 職位列：AQ, AW, BC, BI, BO
    ' 人情報(3列)：AT-AV, AZ-BB, BF-BH, BL-BN, BR-BT
    '   先頭：社員番号 / 2列目：店長 or 社員X / 3列目：異動日（今回は不要）
    Dim dept1 As String, dept2 As String, dept3 As String, dept4 As String
    Dim shopName As String

    Dim posCols(1 To 5) As Long
    Dim startCols(1 To 5) As Long
    posCols(1) = Columns("AQ").Column: startCols(1) = Columns("AT").Column
    posCols(2) = Columns("AW").Column: startCols(2) = Columns("AZ").Column
    posCols(3) = Columns("BC").Column: startCols(3) = Columns("BF").Column
    posCols(4) = Columns("BI").Column: startCols(4) = Columns("BL").Column
    posCols(5) = Columns("BO").Column: startCols(5) = Columns("BR").Column

    Dim blk As Long
    Dim pos As String, empNo As String, label As String

    For r = 5 To lastRow
        dept1 = Trim$(GetMergedText(ws.Cells(r, "Q")))
        dept2 = Trim$(GetMergedText(ws.Cells(r, "W")))
        dept3 = Trim$(GetMergedText(ws.Cells(r, "AC")))
        dept4 = Trim$(GetMergedText(ws.Cells(r, "AI")))
        shopName = Trim$(NzStr(ws.Cells(r, "AO").Value))

        ' ブロック(最大5)を見て、社員番号が入っている分だけ出力
        For blk = 1 To 5
            pos = Trim$(NzStr(ws.Cells(r, posCols(blk)).Value))
            empNo = Trim$(NzStr(ws.Cells(r, startCols(blk) + 0).Value))   ' 社員番号
            label = Trim$(NzStr(ws.Cells(r, startCols(blk) + 1).Value))   ' 店長 or 社員X
            ' startCols(blk) + 2 は異動日（今回は出力不要）

            If empNo <> "" Or label <> "" Or pos <> "" Then
                Dim outR As Long
                outR = NextWriteRow(wsOut)

                ' 共通
                wsOut.Cells(outR, "A").Value = fileBase
                ' B列は触らない

                ' 配属店舗一覧 指定列
                wsOut.Cells(outR, "C").Value = dept1
                ' D列は指定なし（空でOK）
                wsOut.Cells(outR, "E").Value = dept2
                wsOut.Cells(outR, "F").Value = dept3
                wsOut.Cells(outR, "G").Value = dept4

                wsOut.Cells(outR, "H").Value = shopName
                wsOut.Cells(outR, "I").Value = empNo
                wsOut.Cells(outR, "J").Value = label
                wsOut.Cells(outR, "K").Value = pos
            End If
        Next blk
    Next r
End Sub

                          
</code></pre>
</body>
</html>
