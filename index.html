<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>共有コード掲示板</title>
<style>
  :root{
    --ink:#001f3f;
    --blue:#007BFF;
    --bg:#fff;
    --card:#f5f5f5;
    --muted:#666;
    --danger:#c62828;
  }
  body{
    margin:0;
    background:var(--bg);
    color:#000;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
  }
  header{
    position:sticky;
    top:0;
    z-index:10;
    background:#fff;
    border-bottom:2px solid var(--ink);
    padding:10px;
  }
  .toolbar{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .title{
    font-weight:900;
    margin-right:8px;
  }
  button{
    border:2px solid var(--ink);
    background:#fff;
    color:var(--ink);
    border-radius:8px;
    padding:6px 10px;
    font-weight:800;
    cursor:pointer;
    font-size:13px;
  }
  .btn-blue{
    background:var(--blue);
    border-color:var(--blue);
    color:#fff;
  }
  .btn-danger{
    border-color:var(--danger);
    color:var(--danger);
  }
  .hint{
    margin-left:auto;
    color:var(--muted);
    font-size:12px;
  }

  main{ padding:16px; }

  /* ===== 一覧ビュー ===== */
  #listView{ display:none; }
  .listHead{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
    margin-bottom:12px;
  }
  .search{
    flex:1;
    min-width:200px;
    border:1px solid var(--ink);
    border-radius:10px;
    padding:8px 10px;
    font-size:14px;
    outline:none;
  }
  .boardGrid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap:12px;
  }
  .card{
    border:2px solid var(--ink);
    border-radius:12px;
    padding:12px;
    background:#fff;
    display:flex;
    flex-direction:column;
    gap:8px;
    cursor:pointer;
  }
  .card:hover{ background:#fafafa; }
  .cardTitle{
    font-weight:900;
    font-size:15px;
    word-break:break-word;
  }
  .meta{
    color:var(--muted);
    font-size:12px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .empty{
    color:var(--muted);
    border:2px dashed #ccc;
    border-radius:12px;
    padding:14px;
  }

  /* ===== 編集ビュー ===== */
  #editView{ display:none; }
  .panel{
    border:2px solid var(--ink);
    border-radius:12px;
    overflow:hidden;
    background:#fff;
  }
  .panelHead{
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    border-bottom:2px solid var(--ink);
  }
  .panelHead b{ font-size:14px; }
  .status{
    color:var(--muted);
    font-size:12px;
  }
  .panelBody{
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  textarea{
    width:100%;
    min-height: 60vh;
    resize: vertical;
    border:1px solid var(--ink);
    border-radius:10px;
    padding:10px;
    font-family: Consolas, ui-monospace, SFMono-Regular, Menlo, Monaco, "Liberation Mono", monospace;
    font-size:13px;
    line-height:1.45;
    outline:none;
  }
  pre{
    margin:0;
    background:var(--card);
    padding:12px;
    border-radius:10px;
    overflow:auto;
    border:1px solid #ddd;
  }
  .row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .small{ color:var(--muted); font-size:12px; }
  .kbd{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    border:1px solid #ddd;
    border-bottom-width:2px;
    border-radius:6px;
    padding:1px 6px;
    background:#fff;
    color:#222;
  }
</style>
</head>
<body>
<header>
  <div class="toolbar">
    <span class="title">共有コード掲示板</span>

    <button id="btnHome" class="btn-blue" style="display:none">← タイトル一覧</button>
    <button id="btnNew" class="btn-blue">＋ タイトル作成</button>

    <button id="btnCopyUrl" style="display:none">このページURLコピー</button>
    <button id="btnCopyText" style="display:none">コードをコピー</button>
    <button id="btnDelete" class="btn-danger" style="display:none">このタイトルを削除</button>

    <span class="hint">1つのURLに全タイトル一覧 → クリックで共有編集</span>
  </div>
</header>

<main>
  <!-- 一覧 -->
  <section id="listView">
    <div class="listHead">
      <input id="search" class="search" placeholder="タイトル検索（例：異動情報 / VBA / 自動出力）" />
      <span class="small">URL末尾の <span class="kbd">?id=...</span> で直接そのタイトルを開けます</span>
    </div>
    <div id="boardGrid" class="boardGrid"></div>
    <div id="empty" class="empty" style="display:none">
      まだタイトルがありません。「＋ タイトル作成」から作ってください。
    </div>
  </section>

  <!-- 編集 -->
  <section id="editView">
    <div class="panel">
      <div class="panelHead">
        <b id="boardTitle">—</b>
        <span id="status" class="status">—</span>
      </div>
      <div class="panelBody">
        <div class="row">
          <span class="small">※入力後 800ms で自動保存（全員に反映）</span>
          <span class="small">／文字数: <span id="len">0</span></span>
        </div>
        <textarea id="text" spellcheck="false" placeholder="ここにVBAコードを貼り付け（共有編集）"></textarea>
        <pre><code id="preview"></code></pre>
        <div class="small">上はプレビュー（コピー用）。</div>
      </div>
    </div>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getDatabase, ref, set, update, remove, onValue, push, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // ===== Firebase（あなたのタイマーと同じ設定を流用）=====
  const firebaseConfig = {
    apiKey: "AIzaSyB4F-EkDoTZWj_-RE4CZ_mvk44YkgOU888",
    authDomain: "code-share-ab1b4.firebaseapp.com",
    databaseURL: "https://code-share-ab1b4-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "code-share-ab1b4",
    storageBucket: "code-share-ab1b4.firebasestorage.app",
    messagingSenderId: "325792263024",
    appId: "1:325792263024:web:74d7ddcd703266db3dbdb5"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // ===== RTDB パス =====
const BOARDS = "groups_public_code"; // ← boards から変更


  // ===== DOM =====
  const btnHome = document.getElementById("btnHome");
  const btnNew = document.getElementById("btnNew");
  const btnCopyUrl = document.getElementById("btnCopyUrl");
  const btnCopyText = document.getElementById("btnCopyText");
  const btnDelete = document.getElementById("btnDelete");

  const listView = document.getElementById("listView");
  const editView = document.getElementById("editView");
  const boardGrid = document.getElementById("boardGrid");
  const empty = document.getElementById("empty");
  const search = document.getElementById("search");

  const boardTitle = document.getElementById("boardTitle");
  const statusEl = document.getElementById("status");
  const textEl = document.getElementById("text");
  const previewEl = document.getElementById("preview");
  const lenEl = document.getElementById("len");

  // ===== 状態 =====
  let currentId = null;
  let boardsCache = {}; // 一覧用
  let saveTimer = null;
  const SAVE_DEBOUNCE_MS = 800;

  // ===== util =====
  function fmtTime(ms){
    if(!ms) return "";
    const d = new Date(ms);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${y}/${m}/${da} ${hh}:${mm}`;
  }

  function qs(){
    return new URLSearchParams(location.search);
  }
  function setQueryId(id){
    const p = qs();
    if(id) p.set("id", id);
    else p.delete("id");
    history.pushState(null, "", location.pathname + (p.toString()?("?"+p.toString()):""));
  }

  function showList(){
    currentId = null;
    btnHome.style.display = "none";
    btnCopyUrl.style.display = "none";
    btnCopyText.style.display = "none";
    btnDelete.style.display = "none";
    listView.style.display = "";
    editView.style.display = "none";
    renderList(); // キャッシュから
  }

  function showEdit(){
    btnHome.style.display = "";
    btnCopyUrl.style.display = "";
    btnCopyText.style.display = "";
    btnDelete.style.display = "";
    listView.style.display = "none";
    editView.style.display = "";
  }

  function boardRef(id){
    return ref(db, `${BOARDS}/${id}`);
  }

  function escapeHtml(s){
    return (s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function renderPreview(text){
    previewEl.textContent = text || "";
    lenEl.textContent = String((text||"").length);
  }

  // ===== 一覧レンダリング =====
  function renderList(){
    const q = (search.value || "").trim().toLowerCase();
    const entries = Object.entries(boardsCache || {})
      .map(([id, b]) => ({ id, ...(b||{}) }))
      .filter(x => x && typeof x.title === "string" && x.title.trim() !== "");

    // 新しい順（updatedAtが無い場合は0）
    entries.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));

    const filtered = q
      ? entries.filter(x => (x.title||"").toLowerCase().includes(q))
      : entries;

    boardGrid.innerHTML = "";
    empty.style.display = filtered.length ? "none" : "";

    filtered.forEach(item => {
      const card = document.createElement("div");
      card.className = "card";
      const title = item.title || "(無題)";
      const text = typeof item.text === "string" ? item.text : "";
      const lines = text ? text.split(/\r?\n/).length : 0;
      const chars = text.length;

      card.innerHTML = `
        <div class="cardTitle">${escapeHtml(title)}</div>
        <div class="meta">
          <span>更新: ${escapeHtml(fmtTime(item.updatedAt))}</span>
          <span>${chars.toLocaleString()} 文字 / ${lines.toLocaleString()} 行</span>
        </div>
      `;

      card.addEventListener("click", () => openBoard(item.id));
      boardGrid.appendChild(card);
    });
  }

  // ===== タイトル作成 =====
  async function createBoard(){
    const title = prompt("タイトルを入力してください（例：異動情報を自動出力するVBAコード）");
    if(title === null) return;
    const t = title.trim();
    if(!t){
      alert("タイトルを入力してください");
      return;
    }
  
    try{
      const newRef = push(ref(db, BOARDS));
      const id = newRef.key;
  
      await set(newRef, {
        title: t,
        text: "",
        updatedAt: Date.now()
      });
  
      openBoard(id);
    }catch(e){
      console.error(e);
      alert("作成に失敗しました。\n\n原因: " + (e?.message || e));
    }
  }


  // ===== ボードを開く =====
  function openBoard(id){
    currentId = id;
    setQueryId(id);
    showEdit();
    statusEl.textContent = "接続中…";

    // 購読（そのidだけ）
    onValue(boardRef(id), snap => {
      const val = snap.val() || {};
      const title = val.title || "(無題)";
      const text = typeof val.text === "string" ? val.text : "";

      boardTitle.textContent = title;

      // 編集中の上書き事故を減らす：フォーカス中は基本上書きしない（荒らし対策無視の前提で最低限だけ）
      const hasFocus = document.activeElement === textEl;
      if(!hasFocus && textEl.value !== text){
        textEl.value = text;
      }
      renderPreview(textEl.value);

      statusEl.textContent = "接続OK";
    }, err => {
      console.error(err);
      statusEl.textContent = "接続エラー";
    });
  }

  // ===== 保存（自動） =====
  function scheduleSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(async () => {
      if(!currentId) return;
      const text = textEl.value || "";
      try{
        statusEl.textContent = "保存中…";
        await update(boardRef(currentId), {
          text,
          updatedAt: Date.now()
        });
        statusEl.textContent = "保存しました";
        setTimeout(() => {
          if(statusEl.textContent === "保存しました") statusEl.textContent = "接続OK";
        }, 800);
      }catch(e){
        console.error(e);
        statusEl.textContent = "保存エラー";
      }
    }, SAVE_DEBOUNCE_MS);
  }

  textEl.addEventListener("input", () => {
    renderPreview(textEl.value);
    scheduleSave();
  });

  // ===== ボタン =====
  btnNew.addEventListener("click", createBoard);

  btnHome.addEventListener("click", () => {
    setQueryId(null);
    showList();
  });

  btnCopyUrl.addEventListener("click", async () => {
    const url = location.href;
    try{
      await navigator.clipboard.writeText(url);
      statusEl.textContent = "URLをコピーしました";
      setTimeout(() => statusEl.textContent = "接続OK", 800);
    }catch{
      prompt("コピーできない場合は手動でコピーしてください", url);
    }
  });

  btnCopyText.addEventListener("click", async () => {
    const text = textEl.value || "";
    try{
      await navigator.clipboard.writeText(text);
      statusEl.textContent = "コードをコピーしました";
      setTimeout(() => statusEl.textContent = "接続OK", 800);
    }catch{
      alert("コピーに失敗しました（ブラウザ制限の可能性）");
    }
  });

  btnDelete.addEventListener("click", async () => {
    if(!currentId) return;
    const name = boardTitle.textContent || "このタイトル";
    if(!confirm(`「${name}」を削除しますか？`)) return;
    try{
      await remove(boardRef(currentId));
      setQueryId(null);
      showList();
    }catch(e){
      console.error(e);
      alert("削除に失敗しました");
    }
  });

  // ===== 一覧購読（全員が全部見える）=====
  onValue(ref(db, BOARDS), snap => {
    boardsCache = snap.val() || {};
    if(!currentId){
      renderList();
    }
  });

  search.addEventListener("input", renderList);

  // ===== 初期表示（?id= があれば直接開く）=====
  window.addEventListener("popstate", () => {
    const id = qs().get("id");
    if(id) openBoard(id);
    else showList();
  });

  const startId = qs().get("id");
  if(startId){
    openBoard(startId);
  }else{
    showList();
  }
</script>
</body>
</html>
