<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>共有コード掲示板</title>
<style>
  :root{
    --ink:#001f3f;
    --blue:#007BFF;
    --bg:#fff;
    --card:#f5f5f5;
    --muted:#666;
    --danger:#c62828;
  }
  body{
    margin:0;
    background:var(--bg);
    color:#000;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
  }
  header{
    position:sticky;
    top:0;
    z-index:10;
    background:#fff;
    border-bottom:2px solid var(--ink);
    padding:10px;
  }
  .toolbar{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .title{
    font-weight:900;
    margin-right:8px;
  }
  button{
    border:2px solid var(--ink);
    background:#fff;
    color:var(--ink);
    border-radius:8px;
    padding:6px 10px;
    font-weight:800;
    cursor:pointer;
    font-size:13px;
  }
  .btn-blue{
    background:var(--blue);
    border-color:var(--blue);
    color:#fff;
  }
  .btn-danger{
    border-color:var(--danger);
    color:var(--danger);
  }
  .hint{
    margin-left:auto;
    color:var(--muted);
    font-size:12px;
  }

  main{ padding:16px; }

  /* 常に見えるデバッグ枠（まずここが出るかで判定） */
  #debugBox{
    white-space:pre-wrap;
    font-family:Consolas, ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
    font-size:12px;
    color:#b00020;
    padding:10px 12px;
    border:2px dashed #f3b5b5;
    border-radius:10px;
    background:#fffafa;
    margin-bottom:12px;
  }

  /* ===== 一覧ビュー ===== */
  #listView{ display:block; }  /* ← JSが死んでも最低限表示される */
  .listHead{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
    margin-bottom:12px;
  }
  .search{
    flex:1;
    min-width:200px;
    border:1px solid var(--ink);
    border-radius:10px;
    padding:8px 10px;
    font-size:14px;
    outline:none;
  }
  .boardGrid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap:12px;
  }
  .card{
    border:2px solid var(--ink);
    border-radius:12px;
    padding:12px;
    background:#fff;
    display:flex;
    flex-direction:column;
    gap:8px;
    cursor:pointer;
  }
  .card:hover{ background:#fafafa; }
  .cardTitle{
    font-weight:900;
    font-size:15px;
    word-break:break-word;
  }
  .meta{
    color:var(--muted);
    font-size:12px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .empty{
    color:var(--muted);
    border:2px dashed #ccc;
    border-radius:12px;
    padding:14px;
  }

  /* ===== 編集ビュー ===== */
  #editView{ display:none; }
  .panel{
    border:2px solid var(--ink);
    border-radius:12px;
    overflow:hidden;
    background:#fff;
  }
  .panelHead{
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    border-bottom:2px solid var(--ink);
  }
  .panelHead b{ font-size:14px; }
  .status{
    color:var(--muted);
    font-size:12px;
  }
  .panelBody{
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  textarea{
    width:100%;
    min-height: 60vh;
    resize: vertical;
    border:1px solid var(--ink);
    border-radius:10px;
    padding:10px;
    font-family: Consolas, ui-monospace, SFMono-Regular, Menlo, Monaco, "Liberation Mono", monospace;
    font-size:13px;
    line-height:1.45;
    outline:none;
  }
  pre{
    margin:0;
    background:var(--card);
    padding:12px;
    border-radius:10px;
    overflow:auto;
    border:1px solid #ddd;
  }
  .row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .small{ color:var(--muted); font-size:12px; }
  .kbd{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    border:1px solid #ddd;
    border-bottom-width:2px;
    border-radius:6px;
    padding:1px 6px;
    background:#fff;
    color:#222;
  }
</style>
</head>
<body>
<header>
  <div class="toolbar">
    <span class="title">共有コード掲示板</span>

    <button id="btnHome" class="btn-blue" style="display:none">← タイトル一覧</button>
    <button id="btnNew" class="btn-blue">＋ タイトル作成</button>

    <button id="btnCopyUrl" style="display:none">このページURLコピー</button>
    <button id="btnCopyText" style="display:none">コードをコピー</button>
    <button id="btnDelete" class="btn-danger" style="display:none">このタイトルを削除</button>

    <span class="hint">1つのURLに全タイトル一覧 → クリックで共有編集</span>
  </div>
</header>

<main>
  <div id="debugBox">BOOT: まだJSが動いているか確認中…</div>

  <!-- 一覧 -->
  <section id="listView">
    <div class="listHead">
      <input id="search" class="search" placeholder="タイトル検索（例：異動情報 / VBA / 自動出力）" />
      <span class="small">URL末尾の <span class="kbd">?id=...</span> で直接そのタイトルを開けます</span>
    </div>
    <div id="boardGrid" class="boardGrid"></div>
    <div id="empty" class="empty">
      ※もしここから先が変化しない場合、JS（type="module"）が動いていません。
    </div>
  </section>

  <!-- 編集 -->
  <section id="editView">
    <div class="panel">
      <div class="panelHead">
        <b id="boardTitle">—</b>
        <span id="status" class="status">—</span>
      </div>
      <div class="panelBody">
        <div class="row">
          <span class="small">※入力後 800ms で自動保存（全員に反映）</span>
          <span class="small">／文字数: <span id="len">0</span></span>
        </div>
        <textarea id="text" spellcheck="false" placeholder="ここにVBAコードを貼り付け（共有編集）"></textarea>
        <pre><code id="preview"></code></pre>
        <div class="small">上はプレビュー（コピー用）。</div>
      </div>
    </div>
  </section>
</main>

<!-- ★ module が死んでも動く “外側デバッグ” -->
<script>
  const debugBox = document.getElementById("debugBox");
  function dbg(msg){
    console.log("[DBG]", msg);
    debugBox.textContent += "\n" + msg;
  }

  dbg("BOOT OK: 通常scriptは動いています（=HTML反映はされています）");

  window.addEventListener("error", (e) => dbg("GLOBAL ERROR: " + e.message));
  window.addEventListener("unhandledrejection", (e) => dbg("GLOBAL PROMISE ERROR: " + (e.reason && e.reason.message ? e.reason.message : e.reason)));

  // 2秒待って module 側が起動しなければ警告
  setTimeout(() => {
    if (!window.__MODULE_OK__) {
      dbg("MODULE NG: type='module' が起動していません。");
      dbg("原因候補: import失敗 / CDNブロック / 構文エラー / 古いキャッシュ");
      dbg("対策: Ctrl+F5 / URLに ?v=3 を付ける / DevToolsのConsole/Networkを見る");
    }
  }, 2000);
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, set, update, remove, onValue, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // module が起動した印（外側scriptが2秒後にチェックする）
  window.__MODULE_OK__ = true;

  // module 内のログを画面にも出す
  const debugBox = document.getElementById("debugBox");
  const mdbg = (msg) => { console.log("[MDBG]", msg); debugBox.textContent += "\n" + msg; };

  mdbg("MODULE OK: module script 起動しました");
  mdbg("IMPORT OK: firebase modules 読み込み成功");

  const firebaseConfig = {
    apiKey: "AIzaSyB4F-EkDoTZWj_-RE4CZ_mvk44YkgOU888",
    authDomain: "code-share-ab1b4.firebaseapp.com",
    databaseURL: "https://code-share-ab1b4-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "code-share-ab1b4",
    storageBucket: "code-share-ab1b4.firebasestorage.app",
    messagingSenderId: "325792263024",
    appId: "1:325792263024:web:74d7ddcd703266db3dbdb5"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  mdbg("FIREBASE OK: init " + firebaseConfig.projectId);

  const BOARDS = "groups_public_code";

  // ===== DOM =====
  const btnHome = document.getElementById("btnHome");
  const btnNew = document.getElementById("btnNew");
  const btnCopyUrl = document.getElementById("btnCopyUrl");
  const btnCopyText = document.getElementById("btnCopyText");
  const btnDelete = document.getElementById("btnDelete");

  const listView = document.getElementById("listView");
  const editView = document.getElementById("editView");
  const boardGrid = document.getElementById("boardGrid");
  const empty = document.getElementById("empty");
  const search = document.getElementById("search");

  const boardTitle = document.getElementById("boardTitle");
  const statusEl = document.getElementById("status");
  const textEl = document.getElementById("text");
  const previewEl = document.getElementById("preview");
  const lenEl = document.getElementById("len");

  // ===== 状態 =====
  let currentId = null;
  let boardsCache = {};
  let saveTimer = null;
  const SAVE_DEBOUNCE_MS = 800;

  function fmtTime(ms){
    if(!ms) return "";
    const d = new Date(ms);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${y}/${m}/${da} ${hh}:${mm}`;
  }

  function qs(){ return new URLSearchParams(location.search); }
  function setQueryId(id){
    const p = qs();
    if(id) p.set("id", id);
    else p.delete("id");
    history.pushState(null, "", location.pathname + (p.toString()?("?"+p.toString()):""));
  }

  function showList(){
    currentId = null;

    btnHome.style.display = "none";
    btnCopyUrl.style.display = "none";
    btnCopyText.style.display = "none";
    btnDelete.style.display = "none";

    listView.style.display = "block";
    editView.style.display = "none";

    renderList();
  }

  function showEdit(){
    btnHome.style.display = "inline-block";
    btnCopyUrl.style.display = "inline-block";
    btnCopyText.style.display = "inline-block";
    btnDelete.style.display = "inline-block";

    listView.style.display = "none";
    editView.style.display = "block";
  }

  function boardRef(id){ return ref(db, `${BOARDS}/${id}`); }
  function escapeHtml(s){
    return (s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }
  function renderPreview(text){
    previewEl.textContent = text || "";
    lenEl.textContent = String((text||"").length);
  }

  function renderList(){
    const q = (search.value || "").trim().toLowerCase();
    const entries = Object.entries(boardsCache || {})
      .map(([id, b]) => ({ id, ...(b||{}) }))
      .filter(x => x && typeof x.title === "string" && x.title.trim() !== "");

    entries.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
    const filtered = q ? entries.filter(x => (x.title||"").toLowerCase().includes(q)) : entries;

    boardGrid.innerHTML = "";
    empty.style.display = filtered.length ? "none" : "";

    filtered.forEach(item => {
      const card = document.createElement("div");
      card.className = "card";
      const title = item.title || "(無題)";
      const text = typeof item.text === "string" ? item.text : "";
      const lines = text ? text.split(/\r?\n/).length : 0;
      const chars = text.length;

      card.innerHTML = `
        <div class="cardTitle">${escapeHtml(title)}</div>
        <div class="meta">
          <span>更新: ${escapeHtml(fmtTime(item.updatedAt))}</span>
          <span>${chars.toLocaleString()} 文字 / ${lines.toLocaleString()} 行</span>
        </div>
      `;
      card.addEventListener("click", () => openBoard(item.id));
      boardGrid.appendChild(card);
    });
  }

  async function createBoard(){
    const title = prompt("タイトルを入力してください（例：異動情報を自動出力するVBAコード）");
    if(title === null) return;
    const t = title.trim();
    if(!t){ alert("タイトルを入力してください"); return; }

    try{
      const newRef = push(ref(db, BOARDS));
      const id = newRef.key;
      await set(newRef, { title:t, text:"", updatedAt: Date.now() });
      openBoard(id);
    }catch(e){
      console.error(e);
      alert("作成に失敗: " + (e?.message || e));
      mdbg("createBoard failed: " + (e?.message || e));
    }
  }

  function openBoard(id){
    currentId = id;
    setQueryId(id);
    showEdit();
    statusEl.textContent = "接続中…";

    onValue(boardRef(id), snap => {
      const val = snap.val() || {};
      const title = val.title || "(無題)";
      const text = typeof val.text === "string" ? val.text : "";

      boardTitle.textContent = title;
      const hasFocus = document.activeElement === textEl;
      if(!hasFocus && textEl.value !== text) textEl.value = text;
      renderPreview(textEl.value);

      statusEl.textContent = "接続OK";
    }, err => {
      console.error(err);
      statusEl.textContent = "接続エラー";
      mdbg("openBoard onValue error: " + (err?.message || err));
    });
  }

  function scheduleSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(async () => {
      if(!currentId) return;
      const text = textEl.value || "";
      try{
        statusEl.textContent = "保存中…";
        await update(boardRef(currentId), { text, updatedAt: Date.now() });
        statusEl.textContent = "保存しました";
        setTimeout(() => {
          if(statusEl.textContent === "保存しました") statusEl.textContent = "接続OK";
        }, 800);
      }catch(e){
        console.error(e);
        statusEl.textContent = "保存エラー";
        mdbg("save failed: " + (e?.message || e));
      }
    }, SAVE_DEBOUNCE_MS);
  }

  textEl.addEventListener("input", () => { renderPreview(textEl.value); scheduleSave(); });

  btnNew.addEventListener("click", createBoard);
  btnHome.addEventListener("click", () => { setQueryId(null); showList(); });

  btnCopyUrl.addEventListener("click", async () => {
    const url = location.href;
    try{
      await navigator.clipboard.writeText(url);
      statusEl.textContent="URLをコピーしました";
      setTimeout(()=>statusEl.textContent="接続OK",800);
    }catch{
      prompt("コピーできない場合は手動でコピーしてください", url);
    }
  });

  btnCopyText.addEventListener("click", async () => {
    const text = textEl.value || "";
    try{
      await navigator.clipboard.writeText(text);
      statusEl.textContent="コードをコピーしました";
      setTimeout(()=>statusEl.textContent="接続OK",800);
    }catch{
      alert("コピーに失敗しました");
    }
  });

  btnDelete.addEventListener("click", async () => {
    if(!currentId) return;
    const name = boardTitle.textContent || "このタイトル";
    if(!confirm(`「${name}」を削除しますか？`)) return;
    try{
      await remove(boardRef(currentId));
      setQueryId(null);
      showList();
    }catch(e){
      console.error(e);
      alert("削除に失敗しました");
    }
  });

  onValue(ref(db, BOARDS), snap => {
    boardsCache = snap.val() || {};
    if(!currentId) renderList();
  }, err => {
    console.error(err);
    mdbg("list onValue error: " + (err?.message || err));
  });

  search.addEventListener("input", renderList);

  window.addEventListener("popstate", () => {
    const id = qs().get("id");
    if(id) openBoard(id);
    else showList();
  });

  const startId = qs().get("id");
  if(startId) openBoard(startId);
  else showList();
</script>


</body>
</html>
