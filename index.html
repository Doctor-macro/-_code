<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>VBA Code Share</title>
<style>
  body { font-family: Consolas, monospace; padding: 20px; }
  pre {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
  }
</style>
</head>
<body>
<h2>VBA Code</h2>
<pre><code>

=LAMBDA(p,
  XMATCH(p,
  {"総括部長/本部長","事業部長","副本部長","本部長代行","部長","企画担当部長","センター長","部長代行","次長","室長","課長","店長","PS店長","室長代行","課長代行","副店長","MGR","AMGR/CMGR","ユニットリーダー","チームリーダー","サブリーダー","ハピカンキャプテン","一般社員","PS社員","派遣社員","契約社員","外部"},
  0)
)


  =LAMBDA(emp, m,
  LET(
    ID,Sheet1!$J$4:$J$20000,
    Mon,Sheet1!$C$4:$C$20000,
    Pos,Sheet1!$L$4:$L$20000,
    list, UNIQUE(FILTER(Pos,(ID=emp)*(Mon=m))),
    sorted, SORTBY(list, MAP(list, 役職ランク)),
    TEXTJOIN("／",,sorted)
  )
)


  =LAMBDA(emp, m,
  LET(
    ID,Sheet1!$J$4:$J$20000,
    Mon,Sheet1!$C$4:$C$20000,
    Pos,Sheet1!$L$4:$L$20000,
    list, UNIQUE(FILTER(Pos,(ID=emp)*(Mon=m))),
    MIN(MAP(list, 役職ランク))
  )
)





  =LET(
  base,$B$2,
  prev,EDATE(base,-1),

  ID,Sheet1!$J$4:$J$20000,
  NM,Sheet1!$K$4:$K$20000,
  Mon,Sheet1!$C$4:$C$20000,

  idsBase, UNIQUE(FILTER(ID, Mon=base)),
  idsPrev, UNIQUE(FILTER(ID, Mon=prev)),
  common, FILTER(idsBase, ISNUMBER(MATCH(idsBase, idsPrev, 0))),

  chg, FILTER(common, MAP(common, LAMBDA(e, 月別最高位ランク(e,prev)<>月別最高位ランク(e,base)))),

  makeRow, LAMBDA(e,
    LET(
      nameNow, XLOOKUP(e, FILTER(ID,Mon=base), FILTER(NM,Mon=base)),
      rPrev, TAKE(TEXTSPLIT(月別職位文字列(e,prev),"／"),,7),
      rBase, TAKE(TEXTSPLIT(月別職位文字列(e,base),"／"),,7),

      rankPrev, 月別最高位ランク(e,prev),
      rankBase, 月別最高位ランク(e,base),
      kubun, IF(rankBase<rankPrev,"昇格",IF(rankBase>rankPrev,"降格","")),

      HSTACK(kubun, e, nameNow, rPrev, rBase)
    )
  ),

  MAP(chg, makeRow)
)

                          
</code></pre>
</body>
</html>
