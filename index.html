<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>VBA Code Share</title>
<style>
  body { font-family: Consolas, monospace; padding: 20px; }
  pre {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
  }
</style>
</head>
<body>
<h2>VBA Code</h2>
<pre><code>

  
Option Explicit

' 仕込品の単価を新しいシート「仕込単価」に出すマクロ
Public Sub 仕込品単価を計算()

    Dim wsC As Worksheet, wsD As Worksheet, wsOut As Worksheet
    Dim dictFukuUnit As Object          ' 副食材名 -> (単価, 単位)
    Dim dictShikomiComp As Object       ' 仕込品名 -> Collection(材料行)
    Dim dictShikomiBatch As Object      ' 仕込品名 -> (完成量, 単位)
    Dim dictShikomiUnit As Object       ' 仕込品名 -> (単価, 単位)
    Dim lastRow As Long, i As Long
    Dim key As Variant
    
    ' ==== ★ここをあなたのシートタブ名に合わせて変えてください ====
    Set wsC = ThisWorkbook.Worksheets("C")   ' 仕込品の構造があるシート
    Set wsD = ThisWorkbook.Worksheets("D")   ' 副食材マスタ（規格量・価格）
    ' ==============================================================
    
    ' 出力用シート「仕込単価」を用意（なければ作る）
    On Error Resume Next
    Set wsOut = ThisWorkbook.Worksheets("仕込単価")
    On Error GoTo 0
    If wsOut Is Nothing Then
        Set wsOut = ThisWorkbook.Worksheets.Add(After:=wsD)
        wsOut.Name = "仕込単価"
    End If
    wsOut.Cells.Clear
    
    ' 辞書の用意
    Set dictFukuUnit = CreateObject("Scripting.Dictionary")
    Set dictShikomiComp = CreateObject("Scripting.Dictionary")
    Set dictShikomiBatch = CreateObject("Scripting.Dictionary")
    Set dictShikomiUnit = CreateObject("Scripting.Dictionary")
    
    ' --- Dシート：副食材の単価を作成（規格価格 ÷ 規格量） ---
    lastRow = wsD.Cells(wsD.Rows.Count, "A").End(xlUp).Row
    
    For i = 2 To lastRow
        Dim fName As String
        Dim vQty As Variant, vPrice As Variant, unitStr As String
        Dim qty As Double, price As Double, unitPrice As Variant
        
        fName = CStr(wsD.Cells(i, "A").Value)
        If fName <> "" Then
            vQty = wsD.Cells(i, "B").Value
            vPrice = wsD.Cells(i, "I").Value
            unitStr = CStr(wsD.Cells(i, "C").Value)
            
            If IsNumeric(vQty) Then
                qty = CDbl(vQty)
            Else
                qty = 0
            End If
            
            If IsNumeric(vPrice) Then
                price = CDbl(vPrice)
            Else
                price = 0
            End If
            
            If qty <> 0 And price <> 0 Then
                unitPrice = price / qty     ' 円 / 単位
            Else
                unitPrice = Empty
            End If
            
            dictFukuUnit(fName) = Array(unitPrice, unitStr)
        End If
    Next i
    
    ' --- Cシート：仕込品の構造を読み込み ---
    lastRow = wsC.Cells(wsC.Rows.Count, "A").End(xlUp).Row
    
    For i = 2 To lastRow
        Dim sName As String              ' 仕込品名
        Dim compName As String           ' 材料名（仕込品 or 副食材）
        Dim compType As String           ' 種別（仕込品 / 副食材）
        Dim compQtyVar As Variant        ' 使用量(Variant)
        Dim compQty As Double
        Dim compUnit As String
        Dim batchQtyVar As Variant, batchQty As Double
        Dim batchUnit As String
        Dim col As Collection
        
        sName = CStr(wsC.Cells(i, "A").Value)
        If sName <> "" Then
            
            ' 完成量・単位（仕込品全体のバッチ）
            batchQtyVar = wsC.Cells(i, "C").Value
            batchUnit = CStr(wsC.Cells(i, "D").Value)
            If Not dictShikomiBatch.Exists(sName) Then
                If IsNumeric(batchQtyVar) Then
                    batchQty = CDbl(batchQtyVar)
                Else
                    batchQty = 0
                End If
                dictShikomiBatch(sName) = Array(batchQty, batchUnit)
            End If
            
            ' 材料（E～H）
            compName = CStr(wsC.Cells(i, "E").Value)
            If compName <> "" Then
                compType = CStr(wsC.Cells(i, "F").Value)
                compQtyVar = wsC.Cells(i, "G").Value
                compUnit = CStr(wsC.Cells(i, "H").Value)
                
                If IsNumeric(compQtyVar) Then
                    compQty = CDbl(compQtyVar)
                Else
                    compQty = 0
                End If
                
                If dictShikomiComp.Exists(sName) Then
                    Set col = dictShikomiComp(sName)
                Else
                    Set col = New Collection
                    dictShikomiComp.Add sName, col
                End If
                
                ' 材料1つ分の情報を格納：名前, 種別, 使用量, 単位
                col.Add Array(compName, compType, compQty, compUnit)
            End If
        End If
    Next i
    
    ' --- 各仕込品について単価計算（再帰的に） ---
    For Each key In dictShikomiComp.Keys
        Dim visited As Object
        Set visited = CreateObject("Scripting.Dictionary")
        Call CalcShikomiUnitPrice(CStr(key), dictShikomiComp, dictShikomiBatch, _
                                  dictFukuUnit, dictShikomiUnit, visited)
    Next key
    
    ' --- 結果を「仕込単価」シートに出力 ---
    Dim r As Long
    r = 1
    wsOut.Cells(r, 1).Value = "仕込品名"
    wsOut.Cells(r, 2).Value = "完成量"
    wsOut.Cells(r, 3).Value = "単位"
    wsOut.Cells(r, 4).Value = "単位単価"
    wsOut.Cells(r, 5).Value = "単価単位"   ' 例：円/g
    
    r = 2
    For Each key In dictShikomiBatch.Keys
        Dim batchInfo As Variant, unitInfo As Variant
        Dim unitPriceSh As Variant, unitStrSh As String
        
        batchInfo = dictShikomiBatch(key)
        If dictShikomiUnit.Exists(key) Then
            unitInfo = dictShikomiUnit(key)
            unitPriceSh = unitInfo(0)
            unitStrSh = CStr(unitInfo(1))
        Else
            unitPriceSh = Empty
            unitStrSh = CStr(batchInfo(1))
        End If
        
        wsOut.Cells(r, 1).Value = CStr(key)
        wsOut.Cells(r, 2).Value = batchInfo(0)      ' 完成量
        wsOut.Cells(r, 3).Value = CStr(batchInfo(1)) ' 単位
        wsOut.Cells(r, 4).Value = unitPriceSh       ' 単位単価（円/単位）
        wsOut.Cells(r, 5).Value = "円/" & unitStrSh
        
        r = r + 1
    Next key
    
    wsOut.Columns.AutoFit
    
    MsgBox "仕込品の単位単価を「仕込単価」シートに出力しました。", vbInformation

End Sub

' 再帰的に仕込品の単価を計算する
Private Sub CalcShikomiUnitPrice( _
    ByVal sName As String, _
    ByVal dictShikomiComp As Object, _
    ByVal dictShikomiBatch As Object, _
    ByVal dictFukuUnit As Object, _
    ByVal dictShikomiUnit As Object, _
    ByVal visited As Object)

    Dim comps As Collection
    Dim batchInfo As Variant
    Dim batchQty As Double, batchUnit As String
    Dim totalCost As Double
    Dim i As Long
    Dim comp As Variant
    Dim compName As String, compType As String
    Dim compQty As Double, compUnit As String
    Dim subInfo As Variant, subPrice As Variant, subUnit As String
    Dim fInfo As Variant, fPrice As Variant, fUnit As String
    
    ' すでに計算済みなら何もしない
    If dictShikomiUnit.Exists(sName) Then Exit Sub
    
    ' 巡回参照防止
    If visited.Exists(sName) Then Exit Sub
    visited.Add sName, True
    
    ' 構造 or バッチ情報がなければ計算不可
    If Not dictShikomiComp.Exists(sName) Then Exit Sub
    If Not dictShikomiBatch.Exists(sName) Then Exit Sub
    
    Set comps = dictShikomiComp(sName)
    batchInfo = dictShikomiBatch(sName)
    batchQty = batchInfo(0)
    batchUnit = CStr(batchInfo(1))
    
    If batchQty = 0 Then
        dictShikomiUnit(sName) = Array(Empty, batchUnit)
        Exit Sub
    End If
    
    totalCost = 0#
    
    ' 各材料のコストを積み上げ
    For i = 1 To comps.Count
        comp = comps(i)
        compName = CStr(comp(0))
        compType = CStr(comp(1))
        compQty = CDbl(comp(2))
        compUnit = CStr(comp(3))
        
        If compQty = 0 Then GoTo NextComp
        
        ' 副食材の場合
        If compType = "副食材" Or Left$(compName, 3) = "【副】" Then
            If dictFukuUnit.Exists(compName) Then
                fInfo = dictFukuUnit(compName)
                fPrice = fInfo(0)         ' 円/単位
                fUnit = CStr(fInfo(1))    ' 例えば g
                
                If IsNumeric(fPrice) Then
                    totalCost = totalCost + CDbl(fPrice) * compQty
                End If
            End If
        
        ' 仕込品の場合（再帰的に子の単価を計算）
        ElseIf compType = "仕込品" Or Left$(compName, 3) = "【仕】" Then
            ' まだ単価がなければ計算
            If Not dictShikomiUnit.Exists(compName) Then
                Call CalcShikomiUnitPrice(compName, dictShikomiComp, dictShikomiBatch, _
                                          dictFukuUnit, dictShikomiUnit, visited)
            End If
            
            If dictShikomiUnit.Exists(compName) Then
                subInfo = dictShikomiUnit(compName)
                subPrice = subInfo(0)     ' 円/単位
                subUnit = CStr(subInfo(1))
                
                If IsNumeric(subPrice) Then
                    totalCost = totalCost + CDbl(subPrice) * compQty
                End If
            End If
        End If
        
NextComp:
    Next i
    
    ' バッチ全体のコスト ÷ 完成量 = 単位単価
    Dim unitPrice As Variant
    If totalCost = 0 Then
        unitPrice = Empty
    Else
        unitPrice = totalCost / batchQty
    End If
    
    dictShikomiUnit(sName) = Array(unitPrice, batchUnit)

End Sub


  

                          
</code></pre>
</body>
</html>
