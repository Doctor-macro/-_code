<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>VBA Code Share</title>
<style>
  body { font-family: Consolas, monospace; padding: 20px; }
  pre {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
  }
</style>
</head>
<body>
<h2>VBA Code</h2>
<pre><code>
















Option Explicit

'========================================================
' メイン：全シートを走査して「表示用」へ追記
'========================================================
Public Sub レシピ_表示用へ集約()
    Const DISPLAY_SHEET As String = "表示用"
    
    Dim wb As Workbook: Set wb = ThisWorkbook
    Dim wsDisp As Worksheet
    Set wsDisp = wb.Worksheets(DISPLAY_SHEET)
    
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual
    
    On Error GoTo EH
    
    Dim ws As Worksheet
    For Each ws In wb.Worksheets
        If ws.Name <> DISPLAY_SHEET Then
            CollectOneSheet ws, wsDisp
        End If
    Next ws
    
    MsgBox "集約が完了しました。", vbInformation
    
SafeExit:
    Application.ScreenUpdating = True
    Application.EnableEvents = True
    Application.Calculation = xlCalculationAutomatic
    Exit Sub
    
EH:
    MsgBox "エラー: " & Err.Number & vbCrLf & Err.Description, vbExclamation
    Resume SafeExit
End Sub

'========================================================
' 1シート分を集約（他シートは読み取りのみ）
'========================================================
Private Sub CollectOneSheet(ByVal wsSrc As Worksheet, ByVal wsDisp As Worksheet)
    '---- メニュー名（F5:AD5 の結合セル）
    Dim menuName As String
    menuName = GetMergedText(wsSrc.Range("F5"))
    If Trim(menuName) = "" Then Exit Sub  'メニュー名が無いシートはスキップ
    
    '---- 仕込みレシピを先に辞書化（キー=食材名称「【仕込】～」）
    Dim prepDict As Object
    Set prepDict = CreateObject("Scripting.Dictionary")
    
    ' 仕込みブロック：G-Z と AI-BB、45-66 と 69-90
    BuildPrepDict wsSrc, prepDict, 45, 66, "G"   'G-Z
    BuildPrepDict wsSrc, prepDict, 69, 90, "G"   'G-Z
    BuildPrepDict wsSrc, prepDict, 45, 66, "AI"  'AI-BB
    BuildPrepDict wsSrc, prepDict, 69, 90, "AI"  'AI-BB
    
    '---- 表示用の追記開始行（A列の最終行+1）
    Dim outRow As Long
    outRow = wsDisp.Cells(wsDisp.Rows.Count, "A").End(xlUp).Row + 1
    If outRow < 2 Then outRow = 2 '見出しがある想定なら2から
    
    '---- メニューレシピ（21-42行、G-Z）
    Dim r As Long
    For r = 21 To 42
        Dim flag As String, itemName As String, amount As String, unit As String, weight As String
        ReadRecipeRow wsSrc, r, "G", flag, itemName, amount, unit, weight
        
        ' 空行っぽいものはスキップ（必要なら条件変更OK）
        If Trim(flag) = "" And Trim(itemName) = "" And Trim(amount) = "" And Trim(unit) = "" And Trim(weight) = "" Then
            ' do nothing
        Else
            If Trim(flag) = "仕" Then
                ' 仕込み展開：辞書にあればそれを出力、なければこの行だけ出力
                If prepDict.Exists(itemName) Then
                    outRow = WritePrepToDisplay(wsDisp, outRow, menuName, prepDict(itemName))
                Else
                    WriteOneToDisplay wsDisp, outRow, menuName, flag, itemName, amount, unit, weight
                    outRow = outRow + 1
                End If
            Else
                ' 通常行
                WriteOneToDisplay wsDisp, outRow, menuName, flag, itemName, amount, unit, weight
                outRow = outRow + 1
            End If
        End If
    Next r
End Sub

'========================================================
' 仕込みレシピを辞書化
'   - ブロック内で flag="仕" の行を「レシピ開始」とみなす
'   - その次の "仕" が来るまで（またはブロック終端まで）の行を全て保持
'   - 値は Collection（要素は 1行ぶんの配列：flag,name,amount,unit,weight）
'========================================================
Private Sub BuildPrepDict(ByVal ws As Worksheet, ByVal dict As Object, _
                          ByVal rStart As Long, ByVal rEnd As Long, ByVal startColLetter As String)
    Dim r As Long
    Dim currentKey As String
    Dim currentCol As Collection
    
    currentKey = ""
    
    For r = rStart To rEnd
        Dim flag As String, itemName As String, amount As String, unit As String, weight As String
        ReadRecipeRow ws, r, startColLetter, flag, itemName, amount, unit, weight
        
        ' 空っぽ行は無視（必要なら調整）
        If Trim(flag) = "" And Trim(itemName) = "" Then
            ' 何もしない
        Else
            If Trim(flag) = "仕" Then
                ' 新しい仕込み開始
                currentKey = itemName
                Set currentCol = New Collection
                
                ' ヘッダー（仕行）も含めて保存
                currentCol.Add Array(flag, itemName, amount, unit, weight)
                
                ' 同名がすでにあれば上書き（後勝ち）
                If dict.Exists(currentKey) Then
                    dict.Remove currentKey
                End If
                dict.Add currentKey, currentCol
            Else
                ' 仕込み中なら追加
                If currentKey <> "" Then
                    ' ここは 1/2/空白 も入りうるので、そのまま全部入れる
                    currentCol.Add Array(flag, itemName, amount, unit, weight)
                End If
            End If
        End If
    Next r
End Sub

'========================================================
' 仕込み（Collection）を表示用へ書き出し
'========================================================
Private Function WritePrepToDisplay(ByVal wsDisp As Worksheet, ByVal outRow As Long, _
                                   ByVal menuName As String, ByVal col As Collection) As Long
    Dim i As Long
    For i = 1 To col.Count
        Dim a As Variant
        a = col(i) ' Array(flag,name,amount,unit,weight)
        WriteOneToDisplay wsDisp, outRow, menuName, CStr(a(0)), CStr(a(1)), CStr(a(2)), CStr(a(3)), CStr(a(4))
        outRow = outRow + 1
    Next i
    WritePrepToDisplay = outRow
End Function

'========================================================
' 表示用に1行書き込み（A:メニュー名 B:flag C:名称 D:使用量 E:単位 F:重量）
'========================================================
Private Sub WriteOneToDisplay(ByVal ws As Worksheet, ByVal r As Long, _
                             ByVal menuName As String, ByVal flag As String, ByVal name As String, _
                             ByVal amount As String, ByVal unit As String, ByVal weight As String)
    ws.Cells(r, "A").Value = menuName
    ws.Cells(r, "B").Value = flag
    ws.Cells(r, "C").Value = name
    ws.Cells(r, "D").Value = amount
    ws.Cells(r, "E").Value = unit
    ws.Cells(r, "F").Value = weight
End Sub

'========================================================
' 1行分の読み取り（結合セル対応）
'  startColLetter = "G" なら G, H-Q, R-T, U-V, W-Z を読む
'  startColLetter = "AI" なら AI, AJ-AS, AT-AV, AW-AX, AY-BB を読む（同じ幅想定）
'========================================================
Private Sub ReadRecipeRow(ByVal ws As Worksheet, ByVal rowNum As Long, ByVal startColLetter As String, _
                          ByRef flag As String, ByRef itemName As String, ByRef amount As String, _
                          ByRef unit As String, ByRef weight As String)
    Dim sc As Long
    sc = ws.Range(startColLetter & "1").Column
    
    ' オフセットは固定（G基準で：G, H, R, U, W）
    flag = GetMergedText(ws.Cells(rowNum, sc + 0))
    itemName = GetMergedText(ws.Cells(rowNum, sc + 1))   'H側（結合の左上）
    amount = GetMergedText(ws.Cells(rowNum, sc + 11))    'R側
    unit = GetMergedText(ws.Cells(rowNum, sc + 14))      'U側
    weight = GetMergedText(ws.Cells(rowNum, sc + 16))    'W側
End Sub

'========================================================
' 結合セルの左上値を取得
'========================================================
Private Function GetMergedText(ByVal rng As Range) As String
    If rng Is Nothing Then
        GetMergedText = ""
    ElseIf rng.MergeCells Then
        GetMergedText = CStr(rng.MergeArea.Cells(1, 1).Value)
    Else
        GetMergedText = CStr(rng.Value)
    End If
End Function



                          
</code></pre>
</body>
</html>
