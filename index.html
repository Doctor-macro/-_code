<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>VBA Code Share</title>
<style>
  body { font-family: Consolas, monospace; padding: 20px; }
  pre {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
  }
</style>
</head>
<body>
<h2>VBA Code</h2>
<pre><code>

  
Option Explicit

Public Sub 展開レシピ階層を作成()

    Dim wsB As Worksheet, wsC As Worksheet, wsD As Worksheet, wsE As Worksheet
    Dim dictRecipeChildren As Object ' レシピ -> 直下の仕込品/副食材（Bシート）
    Dim dictShikomiChildren As Object ' 仕込品 -> 下の仕込品/副食材（Cシート）
    Dim dictFukuInfo As Object ' 副食材 -> (分量, 単位, 価格)（Dシート）
    Dim lastRow As Long, i As Long
    
    Dim key As Variant
    Dim allPaths As Collection
    Dim maxDepth As Long
    
    ' ==== ★ここをあなたのシートタブ名に合わせて変えてください ====
    Set wsB = ThisWorkbook.Worksheets("B")   ' レシピのシート（元Bシート）
    Set wsC = ThisWorkbook.Worksheets("C")   ' 仕込品のシート（元Cシート）
    Set wsD = ThisWorkbook.Worksheets("D")   ' 副食材のシート（元Dシート）
    Set wsE = ThisWorkbook.Worksheets("E")   ' 展開結果を書き出すシート
    ' ==============================================================
    
    ' --- 辞書の用意 ---
    Set dictRecipeChildren = CreateObject("Scripting.Dictionary")
    Set dictShikomiChildren = CreateObject("Scripting.Dictionary")
    Set dictFukuInfo = CreateObject("Scripting.Dictionary")
    
    ' --- Bシート：レシピ -> 直下の仕込品/副食材 ---
    lastRow = wsB.Cells(wsB.Rows.Count, "A").End(xlUp).Row
    For i = 2 To lastRow   ' 1行目ヘッダ想定
        If wsB.Cells(i, "A").Value <> "" And wsB.Cells(i, "B").Value <> "" Then
            Call AddChild(dictRecipeChildren, _
                          CStr(wsB.Cells(i, "A").Value), _
                          CStr(wsB.Cells(i, "B").Value))
        End If
    Next i
    
    ' --- Cシート：仕込品 -> その下の仕込品/副食材 ---
    lastRow = wsC.Cells(wsC.Rows.Count, "A").End(xlUp).Row
    For i = 2 To lastRow
        If wsC.Cells(i, "A").Value <> "" And wsC.Cells(i, "E").Value <> "" Then
            Call AddChild(dictShikomiChildren, _
                          CStr(wsC.Cells(i, "A").Value), _
                          CStr(wsC.Cells(i, "E").Value))
        End If
    Next i
    
    ' --- Dシート：副食材 -> (規格量, 単位, 価格) ---
    lastRow = wsD.Cells(wsD.Rows.Count, "A").End(xlUp).Row
    For i = 2 To lastRow
        If wsD.Cells(i, "A").Value <> "" Then
            dictFukuInfo(CStr(wsD.Cells(i, "A").Value)) = _
                Array(wsD.Cells(i, "B").Value, wsD.Cells(i, "C").Value, wsD.Cells(i, "I").Value)
        End If
    Next i
    
    ' --- すべてのパス（レシピ → … → 副食材）を作る ---
    Set allPaths = New Collection
    maxDepth = 0
    
    Dim stack As Collection
    Dim item As Variant
    Dim curPath() As String
    Dim newPath() As String
    Dim parentName As String
    Dim depth As Long
    Dim children As Collection
    Dim child As Variant
    Dim j As Long, L As Long
    
    Set stack = New Collection
    
    ' レシピを初期ノードとしてスタックに積む
    For Each key In dictRecipeChildren.Keys
        ReDim curPath(0 To 0)
        curPath(0) = CStr(key)
        item = Array(curPath, CStr(key), 0) ' path, parentName, depth
        stack.Add item
    Next key
    
    ' スタックを使って木をたどる（再帰なし）
    Do While stack.Count > 0
        
        item = stack(stack.Count)
        stack.Remove stack.Count
        
        curPath = item(0)
        parentName = CStr(item(1))
        depth = CLng(item(2))
        
        Set children = Nothing
        
        ' depth=0 のときだけ「レシピ -> Bシートの子」を見る
        If dictRecipeChildren.Exists(parentName) And depth = 0 Then
            Set children = dictRecipeChildren(parentName)
        ' それ以外は「仕込品 -> Cシートの子」
        ElseIf dictShikomiChildren.Exists(parentName) Then
            Set children = dictShikomiChildren(parentName)
        End If
        
        ' 子がいない場合＝葉
        If children Is Nothing Then
            allPaths.Add curPath
            L = UBound(curPath) + 1
            If L > maxDepth Then maxDepth = L
        Else
            ' 子がいる場合、それぞれについて処理
            For Each child In children
                ReDim newPath(0 To UBound(curPath) + 1)
                For j = 0 To UBound(curPath)
                    newPath(j) = curPath(j)
                Next j
                newPath(UBound(newPath)) = CStr(child)
                
                ' 【副】なら葉として保存
                If Left$(CStr(child), 3) = "【副】" Then
                    allPaths.Add newPath
                    L = UBound(newPath) + 1
                    If L > maxDepth Then maxDepth = L
                Else
                    ' さらに下に潜る仕込品なのでスタックに積む
                    item = Array(newPath, CStr(child), depth + 1)
                    stack.Add item
                End If
            Next child
        End If
        
    Loop
    
    ' --- Eシートに書き出し（左から階層、足りないところは副食材で埋める） ---
    Dim ws As Worksheet
    Set ws = wsE
    
    ws.Cells.Clear ' ★Eシートだけクリア
    
    ' ヘッダ（階層1, 階層2, …）
    For i = 1 To maxDepth
        ws.Cells(1, i).Value = "階層" & i
    Next i
    ws.Cells(1, maxDepth + 1).Value = "副食材単価"
    ws.Cells(1, maxDepth + 2).Value = "副食材単位"
    
    ' データ本体
    Dim r As Long
    Dim p As Variant
    Dim col As Long
    Dim leafName As String
    Dim info As Variant
    Dim qty As Double, price As Double
    Dim unitPrice As Variant, unitStr As String
    Dim vQty As Variant, vPrice As Variant
    
    r = 2
    For Each p In allPaths
        curPath = p
        L = UBound(curPath) + 1
        
        ' パスを書き込む（左から順に）
        For i = 0 To L - 1
            ws.Cells(r, i + 1).Value = curPath(i)
        Next i
        
        ' 葉（最後の要素）は副食材
        leafName = curPath(UBound(curPath))
        
        ' 足りない階層は全部「その副食材」で埋める
        For col = L + 1 To maxDepth
            ws.Cells(r, col).Value = leafName
        Next col
        
        ' --- 副食材の単価と単位 ---
        unitPrice = ""
        unitStr = ""
        
        If dictFukuInfo.Exists(leafName) Then
            info = dictFukuInfo(leafName)
            
            vQty = info(0)
            vPrice = info(2)
            unitStr = CStr(info(1))
            
            ' 数値チェック
            If IsNumeric(vQty) Then
                qty = CDbl(vQty)
            Else
                qty = 0
            End If
            
            If IsNumeric(vPrice) Then
                price = CDbl(vPrice)
            Else
                price = 0
            End If
            
            If qty <> 0 And price <> 0 Then
                unitPrice = price / qty  ' 規格価格 ÷ 規格量
            Else
                unitPrice = ""           ' 0で割れない or どちらか欠損 → 空欄
            End If
        End If
        
        ws.Cells(r, maxDepth + 1).Value = unitPrice
        ws.Cells(r, maxDepth + 2).Value = unitStr
        
        r = r + 1
    Next p
    
    ws.Columns.AutoFit
    
    MsgBox "Eシートに展開結果を作成しました。", vbInformation

End Sub

' 親→子リストを Dictionary に登録するだけの小さいSub
Private Sub AddChild(ByVal dict As Object, ByVal parent As String, ByVal child As String)
    Dim col As Collection
    If Not dict.Exists(parent) Then
        Set col = New Collection
        col.Add child
        dict.Add parent, col
    Else
        Set col = dict(parent)
        col.Add child
    End If
End Sub

  

                          
</code></pre>
</body>
</html>
