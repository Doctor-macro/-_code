<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>VBA Code Share</title>
<style>
  body { font-family: Consolas, monospace; padding: 20px; }
  pre {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
  }
</style>
</head>
<body>
<h2>VBA Code</h2>
<pre><code>

Option Explicit

'=========================================================
'  職位変化者 抽出（基準月 vs 前月）
'  条件：
'   - 前月にも基準月にもデータがある人だけ対象（入職/退職は除外）
'   - 同一月に複数職位があっても、最上位（M列最小）だけで比較
'   - 変化がある人だけ出力（変化なしは出さない）
'
'  前提列（反映データ）：
'   C=月（Date: 2025/12/1 等 or "2025年12月" でも可）
'   J=従業員番号, K=氏名, L=職位, M=職位順位(小さいほど上位)
'
'  出力：
'   シート「職位変化」 A4～
'   A2に基準月入力（例：2025年12月 でも 2025/12/1 でもOK）
'=========================================================
Public Sub 抽出_職位変化者_基準月vs前月_変化のみ_入退職除外()

    Dim wsData As Worksheet
    Set wsData = ActiveSheet   ' 反映データのシートをアクティブにして実行

    Dim wsOut As Worksheet
    Set wsOut = GetOrCreateSheet(ThisWorkbook, "職位変化")

    wsOut.Range("A1").Value = "基準月（例：2025年12月 or 2025/12/1）"
    wsOut.Range("B1").Value = "前月（自動）"
    wsOut.Range("A3:H3").Value = Array("従業員番号", "氏名", "前月(月)", "前月職位", "前月順位", "基準月(月)", "基準月職位", "基準月順位")
    wsOut.Range("A4:H1048576").ClearContents

    Dim baseDt As Date
    If Not TryParseMonthCell(wsOut.Range("A2").Value, baseDt) Then
        MsgBox "職位変化シートのA2に基準月を入力してください。（例：2025年12月 または 2025/12/1）", vbExclamation
        Exit Sub
    End If
    baseDt = DateSerial(Year(baseDt), Month(baseDt), 1)

    Dim prevDt As Date
    prevDt = DateAdd("m", -1, baseDt)
    prevDt = DateSerial(Year(prevDt), Month(prevDt), 1)

    Dim baseLabel As String, prevLabel As String
    baseLabel = Format(baseDt, "yyyy年m月")
    prevLabel = Format(prevDt, "yyyy年m月")
    wsOut.Range("B2").Value = prevLabel

    ' 最終行：従業員番号(J)基準
    Dim lastRow As Long
    lastRow = wsData.Cells(wsData.Rows.Count, "J").End(xlUp).Row
    If lastRow < 4 Then
        MsgBox "データが見つかりません（J列=従業員番号が4行目以降にありません）。", vbExclamation
        Exit Sub
    End If

    ' dictPrev(empNo) = Array(rank, name, pos)
    ' dictBase(empNo) = Array(rank, name, pos)
    Dim dictPrev As Object, dictBase As Object
    Set dictPrev = CreateObject("Scripting.Dictionary")
    Set dictBase = CreateObject("Scripting.Dictionary")

    Dim r As Long
    For r = 4 To lastRow
        Dim rowMonthDt As Date
        If Not TryParseMonthCell(wsData.Cells(r, "C").Value, rowMonthDt) Then GoTo ContinueRow
        rowMonthDt = DateSerial(Year(rowMonthDt), Month(rowMonthDt), 1)

        If rowMonthDt <> prevDt And rowMonthDt <> baseDt Then GoTo ContinueRow

        Dim empNo As String
        empNo = Trim$(CStr(wsData.Cells(r, "J").Value))
        If empNo = "" Then GoTo ContinueRow

        Dim nm As String, pos As String
        nm = Trim$(CStr(wsData.Cells(r, "K").Value))
        pos = Trim$(CStr(wsData.Cells(r, "L").Value))

        Dim rankVal As Long
        rankVal = RankOrLarge(wsData.Cells(r, "M").Value)

        If rowMonthDt = prevDt Then
            UpdateBest dictPrev, empNo, rankVal, nm, pos
        ElseIf rowMonthDt = baseDt Then
            UpdateBest dictBase, empNo, rankVal, nm, pos
        End If

ContinueRow:
    Next r

    ' 対象は「前月にも基準月にもいる人」だけ
    Dim outR As Long: outR = 4
    Dim key As Variant

    For Each key In dictPrev.Keys
        If dictBase.Exists(key) Then
            Dim prevRank As Long, baseRank As Long
            Dim prevName As String, baseName As String
            Dim prevPos As String, basePos As String

            prevRank = CLng(dictPrev(key)(0))
            prevName = CStr(dictPrev(key)(1))
            prevPos = CStr(dictPrev(key)(2))

            baseRank = CLng(dictBase(key)(0))
            baseName = CStr(dictBase(key)(1))
            basePos = CStr(dictBase(key)(2))

            ' ★変化ありのみ出力（変化なしは出さない）
            Dim changed As Boolean
            changed = (prevRank <> baseRank) Or (prevPos <> basePos)

            If changed Then
                wsOut.Cells(outR, "A").Value = CStr(key)
                wsOut.Cells(outR, "B").Value = IIf(baseName <> "", baseName, prevName)
                wsOut.Cells(outR, "C").Value = prevLabel
                wsOut.Cells(outR, "D").Value = prevPos
                wsOut.Cells(outR, "E").Value = prevRank
                wsOut.Cells(outR, "F").Value = baseLabel
                wsOut.Cells(outR, "G").Value = basePos
                wsOut.Cells(outR, "H").Value = baseRank
                outR = outR + 1
            End If
        End If
    Next key

    MsgBox "抽出完了：" & (outR - 4) & "件（変化あり・入退職除外）", vbInformation
End Sub

'========================
'  月セルをDate(yyyy/mm/1)に解釈
'  - Date型（2025/12/1）ならそのまま
'  - "2025年12月" 文字列もOK
'========================
Private Function TryParseMonthCell(ByVal v As Variant, ByRef outDt As Date) As Boolean
    TryParseMonthCell = False

    If IsDate(v) Then
        outDt = DateValue(v)
        TryParseMonthCell = True
        Exit Function
    End If

    Dim s As String
    s = Trim$(CStr(v))
    If s = "" Then Exit Function

    Dim y As Long, m As Long
    Dim pY As Long, pM As Long
    pY = InStr(1, s, "年")
    pM = InStr(1, s, "月")
    If pY = 0 Or pM = 0 Or pM <= pY Then Exit Function

    y = CLng(Val(Left$(s, pY - 1)))
    m = CLng(Val(Mid$(s, pY + 1, pM - (pY + 1))))
    If y < 1900 Or y > 2100 Then Exit Function
    If m < 1 Or m > 12 Then Exit Function

    outDt = DateSerial(y, m, 1)
    TryParseMonthCell = True
End Function

Private Function GetOrCreateSheet(ByVal wb As Workbook, ByVal sheetName As String) As Worksheet
    On Error Resume Next
    Set GetOrCreateSheet = wb.Worksheets(sheetName)
    On Error GoTo 0
    If GetOrCreateSheet Is Nothing Then
        Set GetOrCreateSheet = wb.Worksheets.Add(After:=wb.Worksheets(wb.Worksheets.Count))
        GetOrCreateSheet.Name = sheetName
    End If
End Function

Private Function RankOrLarge(ByVal v As Variant) As Long
    If IsError(v) Or IsEmpty(v) Or Trim$(CStr(v)) = "" Then
        RankOrLarge = 999999
    Else
        RankOrLarge = CLng(v)
    End If
End Function

' 同一月・同一人物で最上位（rank最小）だけ保持
Private Sub UpdateBest(ByVal dict As Object, ByVal empNo As String, ByVal rankVal As Long, ByVal name As String, ByVal pos As String)
    If dict.Exists(empNo) Then
        If rankVal < CLng(dict(empNo)(0)) Then
            dict(empNo) = Array(rankVal, name, pos)
        End If
    Else
        dict.Add empNo, Array(rankVal, name, pos)
    End If
End Sub




                          
</code></pre>
</body>
</html>
