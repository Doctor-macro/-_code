<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>VBA Code Share</title>
<style>
  body { font-family: Consolas, monospace; padding: 20px; }
  pre {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
  }
</style>
</head>
<body>
<h2>VBA Code</h2>
<pre><code>







  
  
Private Sub 本社階層表_統合出力_1ファイル( _
        ByVal dstSheetName As String, _
        ByVal dialogTitle As String)

    Dim fPath As Variant
    Dim wbSrc As Workbook
    Dim wsSrc As Worksheet
    
    Dim wbDst As Workbook
    Dim wsDst As Worksheet
    
    Dim levelNames(1 To 5) As String
    Dim levelCol(1 To 5) As Long
    Dim i As Long
    
    Dim hierRow As Long
    Dim headerRow As Long
    Dim dataStartRow As Long
    Dim lastRow As Long
    
    Dim r As Long
    Dim outRow As Long
    
    Dim lvl As Long
    Dim activeLevel As Long
    
    Dim colCode As Long, colName As Long
    Dim colTitle As Long, colEmpNo As Long, colEmpName As Long
    
    Dim c As Range
    Dim testCol As Long
    Dim tmpLast As Long
    Dim valTitle As String, valEmpNo As String, valEmpName As String
    Dim tmpCode As String, tmpName As String
    Dim valD As String   ' 本社シートD列
    
    On Error GoTo ErrHandler
    Application.ScreenUpdating = False
    
    '===== 出力先ブック・シートの準備 =====
    Set wbDst = ThisWorkbook
    On Error Resume Next
    Set wsDst = wbDst.Worksheets(dstSheetName)
    On Error GoTo ErrHandler
    
    If wsDst Is Nothing Then
        Set wsDst = wbDst.Worksheets.Add(After:=wbDst.Sheets(wbDst.Sheets.Count))
        wsDst.Name = dstSheetName
    End If
    
    '===== ファイル選択 =====
    fPath = Application.GetOpenFilename( _
                FileFilter:="Excelファイル (*.xlsx;*.xlsm;*.xls),*.xlsx;*.xlsm;*.xls", _
                Title:=dialogTitle)
    
    If fPath = False Then
        MsgBox "キャンセルされました。（" & dstSheetName & "）", vbInformation
        GoTo ExitPoint
    End If
    
    '===== 本社シートを開く =====
    Set wbSrc = Workbooks.Open(Filename:=fPath, ReadOnly:=True)
    
    On Error Resume Next
    Set wsSrc = wbSrc.Worksheets("本社")
    On Error GoTo ErrHandler
    
    If wsSrc Is Nothing Then
        MsgBox "選択したファイルに「本社」シートがありません。（" & dstSheetName & "）", vbExclamation
        GoTo ExitPoint
    End If
    
    '===== 第1〜第5階層の位置を特定 =====
    levelNames(1) = "第1階層"
    levelNames(2) = "第2階層"
    levelNames(3) = "第3階層"
    levelNames(4) = "第4階層"
    levelNames(5) = "第5階層"
    
    For i = 1 To 5
        Set c = wsSrc.Cells.Find(What:=levelNames(i), LookAt:=xlWhole)
        If c Is Nothing Then
            MsgBox levelNames(i) & " のセルが見つかりません。（" & dstSheetName & "）", vbExclamation
            GoTo ExitPoint
        End If
        levelCol(i) = c.Column
        If i = 1 Then
            hierRow = c.Row
        ElseIf c.Row <> hierRow Then
            MsgBox "第1〜第5階層のセルが同じ行にありません。（" & dstSheetName & "）", vbExclamation
            GoTo ExitPoint
        End If
    Next i
    
    headerRow = hierRow + 1
    dataStartRow = headerRow + 1
    
    '===== 最終行判定 =====
    lastRow = 0
    For i = 1 To 5
        testCol = levelCol(i) + 2   ' 職位
        tmpLast = wsSrc.Cells(wsSrc.Rows.Count, testCol).End(xlUp).Row
        If tmpLast > lastRow Then lastRow = tmpLast
        
        testCol = levelCol(i) + 3   ' 社員番号
        tmpLast = wsSrc.Cells(wsSrc.Rows.Count, testCol).End(xlUp).Row
        If tmpLast > lastRow Then lastRow = tmpLast
        
        testCol = levelCol(i) + 4   ' 氏名
        tmpLast = wsSrc.Cells(wsSrc.Rows.Count, testCol).End(xlUp).Row
        If tmpLast > lastRow Then lastRow = tmpLast
    Next i
    
    If lastRow < dataStartRow Then
        MsgBox "データ行が見つかりません。（" & dstSheetName & "）", vbExclamation
        GoTo ExitPoint
    End If
    
    '===== ここで初めて出力シートをクリア＆ヘッダ設定 =====
    wsDst.Cells.Clear
    
    wsDst.Cells(1, 1).Value = "D列情報"
    wsDst.Cells(1, 2).Value = "第1階層_部門コード"
    wsDst.Cells(1, 3).Value = "第1階層_部門名称"
    wsDst.Cells(1, 4).Value = "第2階層_部門コード"
    wsDst.Cells(1, 5).Value = "第2階層_部門名称"
    wsDst.Cells(1, 6).Value = "第3階層_部門コード"
    wsDst.Cells(1, 7).Value = "第3階層_部門名称"
    wsDst.Cells(1, 8).Value = "第4階層_部門コード"
    wsDst.Cells(1, 9).Value = "第4階層_部門名称"
    wsDst.Cells(1, 10).Value = "第5階層_部門コード"
    wsDst.Cells(1, 11).Value = "第5階層_部門名称"
    wsDst.Cells(1, 12).Value = "職位"
    wsDst.Cells(1, 13).Value = "社員番号"
    wsDst.Cells(1, 14).Value = "氏名"
    
    outRow = 2
    
    '===== データ行ループ =====
    For r = dataStartRow To lastRow
        
        activeLevel = 0
        valTitle = ""
        valEmpNo = ""
        valEmpName = ""
        valD = Trim$(GetMergedText(wsSrc.Cells(r, "D")))  ' 本社D列
        
        ' どの階層に職位・社員番号・氏名がいるか
        For lvl = 1 To 5
            
            colTitle = levelCol(lvl) + 2      ' 職位
            colEmpNo = levelCol(lvl) + 3      ' 社員番号
            colEmpName = levelCol(lvl) + 4    ' 氏名
            
            valTitle = Trim$(GetMergedText(wsSrc.Cells(r, colTitle)))
            valEmpNo = Trim$(GetMergedText(wsSrc.Cells(r, colEmpNo)))
            valEmpName = Trim$(GetMergedText(wsSrc.Cells(r, colEmpName)))
            
            If (valTitle <> "") Or (valEmpNo <> "") Or (valEmpName <> "") Then
                activeLevel = lvl
                Exit For
            End If
        Next lvl
        
        If activeLevel = 0 Then GoTo NextRow
        
        ' D列情報
        wsDst.Cells(outRow, 1).Value = valD
        
        ' 部門コード・名称（階層1〜activeLevel）
        For lvl = 1 To activeLevel
            colCode = levelCol(lvl)
            colName = levelCol(lvl) + 1
            
            tmpCode = Trim$(GetMergedText(wsSrc.Cells(r, colCode)))
            tmpName = Trim$(GetMergedText(wsSrc.Cells(r, colName)))
            
            wsDst.Cells(outRow, 2 * (lvl - 1) + 2).Value = tmpCode
            wsDst.Cells(outRow, 2 * (lvl - 1) + 3).Value = tmpName
        Next lvl
        
        ' 職位・社員番号・氏名
        wsDst.Cells(outRow, 12).Value = valTitle
        wsDst.Cells(outRow, 13).Value = valEmpNo
        wsDst.Cells(outRow, 14).Value = valEmpName
        
        outRow = outRow + 1
        
NextRow:
    Next r
    
    wsDst.Columns("A:N").EntireColumn.AutoFit
    MsgBox dstSheetName & " の出力が完了しました。", vbInformation

ExitPoint:
    On Error Resume Next
    If Not wbSrc Is Nothing Then wbSrc.Close SaveChanges:=False
    Application.ScreenUpdating = True
    On Error GoTo 0
    Exit Sub

ErrHandler:
    MsgBox "エラーが発生しました。（" & dstSheetName & "）" & vbCrLf & _
           Err.Number & " : " & Err.Description, vbCritical
    Resume ExitPoint
End Sub


                          
</code></pre>
</body>
</html>
