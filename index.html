<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>VBA Code Share</title>
<style>
  body { font-family: Consolas, monospace; padding: 20px; }
  pre {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
  }
</style>
</head>
<body>
<h2>VBA Code</h2>
<pre><code>





Option Explicit

' 結合セルから文字列を取得する関数
Private Function GetMergedText(rng As Range) As String
    Dim tmp As Range
    If rng.MergeCells Then
        Set tmp = rng.MergeArea.Cells(1, 1) ' 結合範囲の左上セル
        GetMergedText = CStr(tmp.Value)
    Else
        GetMergedText = CStr(rng.Value)
    End If
End Function


Public Sub 結合セル付き_複数ブック統合_ファイル名付き_全シート()

    Dim wbMaster As Workbook
    Dim wsMaster As Worksheet
    Dim folderPath As String
    Dim fd As FileDialog
    Dim fileName As String
    
    Dim wbSrc As Workbook
    Dim wsSrc As Worksheet
    
    Dim headerMap As Object ' 項目キー → 統合シート列番号
    Dim nextCol As Long
    
    Dim dispCell As Range
    Dim header1Row As Long, header2Row As Long
    Dim dataStartRow As Long
    Dim lastCol As Long, dispCol As Long
    
    Dim c As Long, r As Long
    Dim key As String
    Dim h1 As String, h2 As String
    Dim destCol As Long, destRow As Long
    Dim v As Variant
    
    Dim headerKey() As String
    
    
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    
    Set wbMaster = ThisWorkbook
    Set wsMaster = wbMaster.Worksheets("統合")
    
    ' --- 統合先初期化 ---
    wsMaster.Cells.Clear
    
    ' 固定列（ファイル名・シート名）
    wsMaster.Cells(1, 1).Value = "元ファイル名"
    wsMaster.Cells(1, 2).Value = "元シート名"
    
    ' 項目ヘッダは C列から
    nextCol = 3
    
    Set headerMap = CreateObject("Scripting.Dictionary")
    
    ' --- フォルダ選択 ---
    Set fd = Application.FileDialog(msoFileDialogFolderPicker)
    With fd
        .Title = "統合するExcelファイルが入ったフォルダを選択"
        If Not .Show Then
            MsgBox "キャンセルされました。"
            GoTo EndProc
        End If
        folderPath = .SelectedItems(1)
    End With
    If Right(folderPath, 1) <> "\" Then folderPath = folderPath & "\"
    
    ' --- ファイルループ ---
    fileName = Dir(folderPath & "*.xls*")
    
    Do While fileName <> ""
        
        If fileName <> wbMaster.Name Then
        
            Set wbSrc = Workbooks.Open(folderPath & fileName)
            
            ' --- 全シートループ ---
            For Each wsSrc In wbSrc.Worksheets
                
                ' 「表示名」を探す
                Set dispCell = wsSrc.Cells.Find(What:="表示名", _
                                                LookIn:=xlValues, _
                                                LookAt:=xlWhole, _
                                                SearchOrder:=xlByRows, _
                                                SearchDirection:=xlNext, _
                                                MatchCase:=False)
                If dispCell Is Nothing Then
                    GoTo NextSheet
                End If
                
                header2Row = dispCell.Row
                header1Row = header2Row - 1
                dataStartRow = header2Row + 1
                dispCol = dispCell.Column
                lastCol = dispCol
                
                ' --- ヘッダキー作成 ---
                ReDim headerKey(1 To lastCol)
                
                For c = 1 To lastCol
                    h1 = Trim(GetMergedText(wsSrc.Cells(header1Row, c)))
                    h2 = Trim(GetMergedText(wsSrc.Cells(header2Row, c)))
                    
                    key = h1 & "|" & h2
                    headerKey(c) = key
                    
                    If key <> "|" Then
                        If Not headerMap.Exists(key) Then
                            headerMap.Add key, nextCol
                            wsMaster.Cells(1, nextCol).Value = h1
                            wsMaster.Cells(2, nextCol).Value = h2
                            nextCol = nextCol + 1
                        End If
                    End If
                Next c
                
                ' --- データ行取得 ---
                r = dataStartRow
                Do While LenB(CStr(wsSrc.Cells(r, dispCol).Value)) > 0
                    
                    destRow = wsMaster.Cells(wsMaster.Rows.Count, "A").End(xlUp).Row + 1
                    
                    ' 固定列（元ファイル名・元シート名）
                    wsMaster.Cells(destRow, 1).Value = wbSrc.Name
                    wsMaster.Cells(destRow, 2).Value = wsSrc.Name
                    
                    ' 各項目の値を転記
                    For c = 1 To lastCol
                        key = headerKey(c)
                        If key <> "" And key <> "|" Then
                            If headerMap.Exists(key) Then
                                destCol = headerMap(key)
                                v = wsSrc.Cells(r, c).Value
                                
                                If LenB(CStr(v)) > 0 Then
                                    wsMaster.Cells(destRow, destCol).Value = v
                                End If
                            End If
                        End If
                    Next c
                    
                    r = r + 1
                Loop
                
NextSheet:
            Next wsSrc
            
            wbSrc.Close SaveChanges:=False
        
        End If
        
        fileName = Dir()
    Loop
    
    MsgBox "統合が完了しました。", vbInformation


EndProc:
    Application.EnableEvents = True
    Application.ScreenUpdating = True

End Sub







    

</code></pre>
</body>
</html>
