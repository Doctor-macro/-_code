<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VBA Code Share</title>
<style>
  :root{
    --ink:#001f3f;
    --bg:#fff;
    --muted:#666;
    --card:#f5f5f5;
    --warn:#ff9800;
    --blue:#007BFF;
  }
  body{
    margin:0;
    background:var(--bg);
    color:#000;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
  }
  header{
    position:sticky;
    top:0;
    z-index:10;
    background:#fff;
    border-bottom:2px solid var(--ink);
    padding:10px;
  }
  .toolbar{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .title{
    font-weight:800;
    margin-right:8px;
  }
  button{
    border:2px solid var(--ink);
    background:#fff;
    color:var(--ink);
    border-radius:8px;
    padding:6px 10px;
    font-weight:700;
    cursor:pointer;
    font-size:13px;
  }
  button:disabled{
    border-color:#ccc;
    color:#aaa;
    cursor:not-allowed;
  }
  .btn-blue{
    background:var(--blue);
    border-color:var(--blue);
    color:#fff;
  }
  .hint{
    color:var(--muted);
    font-size:12px;
    margin-left:auto;
  }
  main{
    padding:16px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:16px;
  }
  @media (max-width: 980px){
    main{ grid-template-columns: 1fr; }
  }
  .panel{
    border:2px solid var(--ink);
    border-radius:12px;
    overflow:hidden;
    background:#fff;
    display:flex;
    flex-direction:column;
    min-height: 60vh;
  }
  .panel-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    padding:10px 12px;
    border-bottom:2px solid var(--ink);
    background:#fff;
  }
  .panel-head b{
    font-size:14px;
  }
  .panel-body{
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
    flex:1;
  }
  textarea{
    width:100%;
    min-height: 42vh;
    resize: vertical;
    border:1px solid var(--ink);
    border-radius:10px;
    padding:10px;
    font-family: Consolas, ui-monospace, SFMono-Regular, Menlo, Monaco, "Liberation Mono", monospace;
    font-size:13px;
    line-height:1.45;
    outline:none;
  }
  pre{
    margin:0;
    background:var(--card);
    padding:12px;
    border-radius:10px;
    overflow:auto;
    border:1px solid #ddd;
    flex:1;
  }
  code{
    font-family: Consolas, ui-monospace, SFMono-Regular, Menlo, Monaco, "Liberation Mono", monospace;
    font-size:13px;
    line-height:1.45;
    white-space: pre;
  }
  .row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    border:1px solid #ddd;
    border-radius:999px;
    padding:6px 10px;
    font-size:12px;
    color:#222;
    background:#fff;
  }
  .pill input{
    border:none;
    outline:none;
    width: 260px;
    max-width: 60vw;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    font-size:12px;
  }
  .status{
    font-size:12px;
    color:var(--muted);
  }
  .status.warn{ color: #a85b00; }
  .status.ok{ color: #1b7f2a; }
  .small{
    font-size:12px;
    color:var(--muted);
  }
  .footer-note{
    margin-top:8px;
    padding:10px 12px;
    border-top:1px solid #eee;
    font-size:12px;
    color:var(--muted);
  }
  .kbd{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    border:1px solid #ddd;
    border-bottom-width:2px;
    border-radius:6px;
    padding:1px 6px;
    background:#fff;
    color:#222;
  }
</style>
</head>
<body>
<header>
  <div class="toolbar">
    <span class="title">VBA Code Share</span>

    <button id="btnNewRoom" class="btn-blue">＋ 新しい共有URL</button>
    <button id="btnCopyUrl">共有URLコピー</button>
    <button id="btnCopyOut">出力をコピー</button>
    <button id="btnDownload">出力を保存(.txt)</button>
    <button id="btnFormat">簡易整形</button>
    <button id="btnClear" title="このルームの内容も消えます">このルームをクリア</button>

    <span class="hint">GitHubアカウント不要／URLで共有（誰でも編集）</span>
  </div>
</header>

<main>
  <section class="panel">
    <div class="panel-head">
      <b>入力（みんなで共有）</b>
      <span class="status" id="statusIn">未接続</span>
    </div>
    <div class="panel-body">
      <div class="row">
        <span class="pill">
          room:
          <input id="roomId" readonly>
        </span>
        <span class="small">※URLの <span class="kbd">?room=xxxx</span> が同じ人同士で共有されます</span>
      </div>

      <textarea id="input" spellcheck="false" placeholder="ここにVBAコードを貼り付け（自動保存・共有）"></textarea>

      <div class="footer-note">
        ・自動保存：入力後 800ms で保存（連打防止あり）<br>
        ・上限：入力 50,000 文字（超えると保存しません）<br>
        ・注意：ログイン不要のため、URLを知っている人は誰でも編集できます（荒らし対策は最低限）
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="panel-head">
      <b>出力（表示・コピー用）</b>
      <span class="status" id="statusOut">—</span>
    </div>
    <div class="panel-body">
      <pre><code id="output"></code></pre>
      <div class="small">
        ※ ここは表示専用。入力が更新されると自動で反映します。
      </div>
    </div>
  </section>
</main>

<script type="module">
  // ========= Firebase =========
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getDatabase, ref, set, onValue, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // ★ タイマーと同じプロジェクトを流用（あなたが貼ってくれた内容そのまま）
  const firebaseConfig = {
    apiKey: "AIzaSyCSIIPz6Q8RRH1ijLcU-SD74IWk10lt2Uk",
    authDomain: "multi-timer-share.firebaseapp.com",
    projectId: "multi-timer-share",
    storageBucket: "multi-timer-share.firebasestorage.app",
    messagingSenderId: "619054972489",
    appId: "1:619054972489:web:ee1a5ad15da335f2e68998",
    databaseURL: "https://multi-timer-share-default-rtdb.asia-southeast1.firebasedatabase.app"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // ========= DOM =========
  const btnNewRoom  = document.getElementById("btnNewRoom");
  const btnCopyUrl  = document.getElementById("btnCopyUrl");
  const btnCopyOut  = document.getElementById("btnCopyOut");
  const btnDownload = document.getElementById("btnDownload");
  const btnFormat   = document.getElementById("btnFormat");
  const btnClear    = document.getElementById("btnClear");

  const roomIdEl  = document.getElementById("roomId");
  const inputEl   = document.getElementById("input");
  const outputEl  = document.getElementById("output");
  const statusIn  = document.getElementById("statusIn");
  const statusOut = document.getElementById("statusOut");

  // ========= 設定 =========
  const MAX_LEN = 50000;
  const SAVE_DEBOUNCE_MS = 800;
  const MIN_WRITE_GAP_MS = 1200; // 連続書き込みの間引き
  const PATH_PREFIX = "codeRooms"; // RTDB path

  // ========= room決定 =========
  const params = new URLSearchParams(location.search);
  let room = params.get("room");

  function randRoomId(len = 16){
    const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let s = "";
    const a = new Uint32Array(len);
    crypto.getRandomValues(a);
    for(let i=0;i<len;i++){
      s += chars[a[i] % chars.length];
    }
    return s;
  }

  function setRoom(newRoom){
    room = newRoom;
    roomIdEl.value = room;

    const p = new URLSearchParams(location.search);
    p.set("room", room);
    history.replaceState(null, "", location.pathname + "?" + p.toString());

    subscribeRoom();
    statusOut.textContent = "—";
  }

  if(!room){
    // 初回は自動でroom作る（推測されにくい長さ）
    setRoom(randRoomId(20));
  }else{
    setRoom(room);
  }

  // ========= RTDB参照 =========
  let unsubscribed = false;
  let lastRemoteText = "";
  let lastLocalWriteAt = 0;
  let saveTimer = null;

  function roomRef(){
    return ref(db, `${PATH_PREFIX}/${room}`);
  }

  function subscribeRoom(){
    unsubscribed = false;
    statusIn.textContent = "接続中…";
    statusIn.className = "status";

    onValue(roomRef(), snap => {
      if(unsubscribed) return;

      const val = snap.val() || {};
      const text = typeof val.text === "string" ? val.text : "";

      lastRemoteText = text;

      // ローカル編集が未反映の場合に上書きしない（基本方針）
      // ただし入力欄が空で、リモートにあるなら反映
      if(inputEl.value !== text){
        // 入力中の上書き事故を減らす：フォーカス中で、差分が大きい場合は触らない
        const hasFocus = document.activeElement === inputEl;
        if(!hasFocus || inputEl.value === "" || inputEl.value === lastRemoteText){
          inputEl.value = text;
        }
      }

      renderOutput(text);
      statusIn.textContent = "接続OK";
      statusIn.className = "status ok";
    }, err => {
      statusIn.textContent = "接続エラー";
      statusIn.className = "status warn";
      console.error(err);
    });
  }

  function renderOutput(text){
    outputEl.textContent = text;
    const len = text.length;
    statusOut.textContent = `${len.toLocaleString()} 文字`;
    statusOut.className = "status" + (len > MAX_LEN ? " warn" : "");
  }

  // ========= 保存 =========
  async function saveNow(text){
    const now = Date.now();
    if(now - lastLocalWriteAt < MIN_WRITE_GAP_MS){
      // 間引き（次のデバウンスで保存される）
      return;
    }
    lastLocalWriteAt = now;

    await set(roomRef(), {
      text,
      updatedAt: serverTimestamp()
    });

    statusIn.textContent = "保存しました";
    statusIn.className = "status ok";
    setTimeout(() => {
      if(statusIn.textContent === "保存しました"){
        statusIn.textContent = "接続OK";
        statusIn.className = "status ok";
      }
    }, 900);
  }

  function scheduleSave(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(async () => {
      const text = inputEl.value ?? "";
      if(text.length > MAX_LEN){
        statusIn.textContent = `文字数上限超え（${MAX_LEN.toLocaleString()}文字まで）`;
        statusIn.className = "status warn";
        return;
      }
      try{
        await saveNow(text);
      }catch(e){
        statusIn.textContent = "保存エラー";
        statusIn.className = "status warn";
        console.error(e);
      }
    }, SAVE_DEBOUNCE_MS);
  }

  inputEl.addEventListener("input", () => {
    renderOutput(inputEl.value);
    scheduleSave();
  });

  // ========= 便利機能 =========
  function currentShareUrl(){
    return location.origin + location.pathname + "?room=" + encodeURIComponent(room);
  }

  btnCopyUrl.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(currentShareUrl());
      statusIn.textContent = "共有URLをコピーしました";
      statusIn.className = "status ok";
    }catch{
      prompt("コピーできない場合は手動でコピーしてください", currentShareUrl());
    }
  });

  btnCopyOut.addEventListener("click", async () => {
    const text = outputEl.textContent || "";
    try{
      await navigator.clipboard.writeText(text);
      statusOut.textContent = "コピーしました";
      statusOut.className = "status ok";
      setTimeout(() => renderOutput(inputEl.value), 800);
    }catch{
      alert("コピーに失敗しました（ブラウザ制限の可能性）");
    }
  });

  btnDownload.addEventListener("click", () => {
    const text = outputEl.textContent || "";
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `vba_${room}.txt`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  btnClear.addEventListener("click", async () => {
    if(!confirm("このルームの内容を空にします。よろしいですか？（共有相手にも反映されます）")) return;
    inputEl.value = "";
    renderOutput("");
    try{
      await saveNow("");
    }catch(e){
      statusIn.textContent = "保存エラー";
      statusIn.className = "status warn";
      console.error(e);
    }
  });

  btnNewRoom.addEventListener("click", () => {
    // 新しい共有URL（今の内容は引き継がない）
    setRoom(randRoomId(20));
    inputEl.value = "";
    renderOutput("");
    // 初期保存
    scheduleSave();
  });

  // ========= 簡易整形（安全な範囲） =========
  function simpleFormatVba(text){
    // 1) 末尾空白を削除
    const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n");
    const trimmed = lines.map(l => l.replace(/[ \t]+$/g, ""));

    // 2) 連続空行を最大2行に
    const out = [];
    let blankRun = 0;
    for(const l of trimmed){
      if(l.trim() === ""){
        blankRun++;
        if(blankRun <= 2) out.push("");
      }else{
        blankRun = 0;
        out.push(l);
      }
    }
    return out.join("\n").trimEnd() + "\n";
  }

  btnFormat.addEventListener("click", () => {
    const before = inputEl.value || "";
    const after  = simpleFormatVba(before);
    if(after === before) return;
    inputEl.value = after;
    renderOutput(after);
    scheduleSave();
  });

  // 初期表示
  roomIdEl.value = room;
  renderOutput(inputEl.value || "");
</script>
</body>
</html>
