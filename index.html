<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>VBA Code Share</title>
<style>
  body { font-family: Consolas, monospace; padding: 20px; }
  pre {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
  }
</style>
</head>
<body>
<h2>VBA Code</h2>
<pre><code>

Option Explicit

'========================================================
' 設定（必要ならここだけ変える）
'========================================================
Private Const DISPLAY_SHEET_NAME As String = "表示用"
Private Const MANAGE_SHEET_NAME  As String = "集約管理"

Private Const SOURCE_SHEET_RECIPE_NAME As String = "管理店舗数" '※今回は未使用（前タスク用の名残）
Private Const SRC_START_ROW As Long = 11                         '※今回は未使用

'========================================================
' メイン：未処理レシピシートだけ「表示用」へ追記
'========================================================
Public Sub レシピ_表示用へ集約_未処理だけ()
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual

    On Error GoTo EH

    Dim wb As Workbook: Set wb = ThisWorkbook

    ' 1) 表示用シートが無ければ作る
    Dim wsDisp As Worksheet
    Set wsDisp = GetOrCreateSheet(wb, DISPLAY_SHEET_NAME, afterLast:=True)
    EnsureDisplayHeader wsDisp

    ' 2) 管理シートが無ければ作る（処理済みシート名を保存）
    Dim wsMng As Worksheet
    Set wsMng = GetOrCreateSheet(wb, MANAGE_SHEET_NAME, afterLast:=True)
    EnsureManageHeader wsMng

    ' 3) 管理シートから「処理済み」を読み込む
    Dim done As Object
    Set done = LoadProcessedSheets(wsMng)

    ' 4) 全シートを走査 → レシピっぽい＆未処理だけ集約
    Dim ws As Worksheet
    For Each ws In wb.Worksheets

        ' 表示用/管理は絶対除外
        If ws.Name = wsDisp.Name Then GoTo NextSheet
        If ws.Name = wsMng.Name Then GoTo NextSheet

        ' レシピシート判定（F5:AD5結合なしは除外、メニュー名空も除外）
        If Not IsRecipeSheet(ws) Then GoTo NextSheet

        ' 未処理だけ
        If done.Exists(ws.Name) Then GoTo NextSheet

        ' 集約
        CollectOneRecipeSheet ws, wsDisp

        ' 処理済みとして記録
        AppendProcessedSheet wsMng, ws.Name
        done.Add ws.Name, True

NextSheet:
    Next ws

    MsgBox "集約が完了しました（未処理シートのみ追記）。", vbInformation

SafeExit:
    Application.ScreenUpdating = True
    Application.EnableEvents = True
    Application.Calculation = xlCalculationAutomatic
    Exit Sub

EH:
    MsgBox "エラー: " & Err.Number & vbCrLf & Err.Description, vbExclamation
    Resume SafeExit
End Sub

'========================================================
' 1レシピシート分を集約（読み取りのみ）
'========================================================
Private Sub CollectOneRecipeSheet(ByVal wsSrc As Worksheet, ByVal wsDisp As Worksheet)
    Dim menuName As String
    menuName = GetMergedText(wsSrc.Range("F5")) 'F5:AD5 結合前提
    menuName = Trim(menuName)
    If menuName = "" Then Exit Sub

    '---- 仕込みレシピを先に辞書化（キー=食材名称「【仕込】～」）
    Dim prepDict As Object
    Set prepDict = CreateObject("Scripting.Dictionary")

    ' 仕込みブロック：G-Z と AI-BB、45-66 と 69-90
    BuildPrepDict wsSrc, prepDict, 45, 66, "G"    'G-Z
    BuildPrepDict wsSrc, prepDict, 69, 90, "G"    'G-Z
    BuildPrepDict wsSrc, prepDict, 45, 66, "AI"   'AI-BB
    BuildPrepDict wsSrc, prepDict, 69, 90, "AI"   'AI-BB

    '---- 表示用の追記開始行（A列の最終行+1）
    Dim outRow As Long
    outRow = wsDisp.Cells(wsDisp.Rows.Count, "A").End(xlUp).Row + 1
    If outRow < 2 Then outRow = 2

    '---- メニューレシピ（21-42行、G-Z）
    Dim r As Long
    For r = 21 To 42
        Dim flag As String, itemName As String, amount As String, unit As String, weight As String
        ReadRecipeRow wsSrc, r, "G", flag, itemName, amount, unit, weight

        If IsEmptyRecipeLine(flag, itemName, amount, unit, weight) Then
            'skip
        Else
            If Trim(flag) = "仕" Then
                ' ★まずメニューレシピ側の「仕」行を必ず出す（250/g/250 を保持）
                WriteOneToDisplay wsDisp, outRow, menuName, flag, itemName, amount, unit, weight
                outRow = outRow + 1
            
                ' ★仕込みがあるなら「中身だけ（1/2/空白行）」を追加
                If prepDict.Exists(itemName) Then
                    outRow = WritePrepChildrenToDisplay(wsDisp, outRow, menuName, prepDict(itemName))
                End If
            Else
                WriteOneToDisplay wsDisp, outRow, menuName, flag, itemName, amount, unit, weight
                outRow = outRow + 1
            End If

        End If
    Next r
End Sub

Private Function IsEmptyRecipeLine(ByVal flag As String, ByVal itemName As String, ByVal amount As String, ByVal unit As String, ByVal weight As String) As Boolean
    IsEmptyRecipeLine = (Trim(flag) = "" And Trim(itemName) = "" And Trim(amount) = "" And Trim(unit) = "" And Trim(weight) = "")
End Function

'========================================================
' 仕込みレシピを辞書化
'   - ブロック内で flag="仕" の行を「レシピ開始」とみなす
'   - その次の "仕" が来るまで（またはブロック終端まで）の行を全て保持
'========================================================
Private Sub BuildPrepDict(ByVal ws As Worksheet, ByVal dict As Object, _
                          ByVal rStart As Long, ByVal rEnd As Long, ByVal startColLetter As String)
    Dim r As Long
    Dim currentKey As String
    Dim currentCol As Collection

    currentKey = ""

    For r = rStart To rEnd
        Dim flag As String, itemName As String, amount As String, unit As String, weight As String
        ReadRecipeRow ws, r, startColLetter, flag, itemName, amount, unit, weight

        If Trim(flag) = "" And Trim(itemName) = "" Then
            'skip
        Else
            If Trim(flag) = "仕" Then
                currentKey = itemName
                Set currentCol = New Collection

                currentCol.Add Array(flag, itemName, amount, unit, weight)

                If dict.Exists(currentKey) Then dict.Remove currentKey
                dict.Add currentKey, currentCol
            Else
                If currentKey <> "" Then
                    currentCol.Add Array(flag, itemName, amount, unit, weight)
                End If
            End If
        End If
    Next r
End Sub

'========================================================
' 仕込み（Collection）を表示用へ書き出し
'========================================================
Private Function WritePrepToDisplay(ByVal wsDisp As Worksheet, ByVal outRow As Long, _
                                   ByVal menuName As String, ByVal col As Collection) As Long
    Dim i As Long
    For i = 1 To col.Count
        Dim a As Variant
        a = col(i) ' Array(flag,name,amount,unit,weight)
        WriteOneToDisplay wsDisp, outRow, menuName, CStr(a(0)), CStr(a(1)), CStr(a(2)), CStr(a(3)), CStr(a(4))
        outRow = outRow + 1
    Next i
    WritePrepToDisplay = outRow
End Function
'========================================================
' 仕込み（Collection）の「中身だけ」を表示用へ書き出し
'   ※Collection(1) は「仕」行なので飛ばす
'========================================================
Private Function WritePrepChildrenToDisplay(ByVal wsDisp As Worksheet, ByVal outRow As Long, _
                                           ByVal menuName As String, ByVal col As Collection) As Long
    Dim i As Long
    For i = 2 To col.Count
        Dim a As Variant
        a = col(i) ' Array(flag,name,amount,unit,weight)
        WriteOneToDisplay wsDisp, outRow, menuName, CStr(a(0)), CStr(a(1)), CStr(a(2)), CStr(a(3)), CStr(a(4))
        outRow = outRow + 1
    Next i
    WritePrepChildrenToDisplay = outRow
End Function

'========================================================
' 表示用に1行書き込み（A:メニュー名 B:flag C:名称 D:使用量 E:単位 F:重量）
'========================================================
Private Sub WriteOneToDisplay(ByVal ws As Worksheet, ByVal r As Long, _
                             ByVal menuName As String, ByVal flag As String, ByVal name As String, _
                             ByVal amount As String, ByVal unit As String, ByVal weight As String)
    ws.Cells(r, "A").Value = menuName
    ws.Cells(r, "B").Value = flag
    ws.Cells(r, "C").Value = name
    ws.Cells(r, "D").Value = amount
    ws.Cells(r, "E").Value = unit
    ws.Cells(r, "F").Value = weight
End Sub

'========================================================
' 1行分の読み取り（結合セル対応）
'  startColLetter = "G" なら G, H-Q, R-T, U-V, W-Z を読む
'  startColLetter = "AI" なら AI, AJ-AS, AT-AV, AW-AX, AY-BB を読む想定
'========================================================
Private Sub ReadRecipeRow(ByVal ws As Worksheet, ByVal rowNum As Long, ByVal startColLetter As String, _
                          ByRef flag As String, ByRef itemName As String, ByRef amount As String, _
                          ByRef unit As String, ByRef weight As String)
    Dim sc As Long
    sc = ws.Range(startColLetter & "1").Column

    flag = GetMergedText(ws.Cells(rowNum, sc + 0))
    itemName = GetMergedText(ws.Cells(rowNum, sc + 1))   'H側（結合の左上）
    amount = GetMergedText(ws.Cells(rowNum, sc + 11))    'R側
    unit = GetMergedText(ws.Cells(rowNum, sc + 14))      'U側
    weight = GetMergedText(ws.Cells(rowNum, sc + 16))    'W側
End Sub

'========================================================
' レシピシート判定：
'   - F5:AD5 が「結合」されていて、その結合範囲が F5:AD5 を含む（ほぼ一致）こと
'   - かつメニュー名が空でない
'========================================================
Private Function IsRecipeSheet(ByVal ws As Worksheet) As Boolean
    On Error GoTo NG

    Dim c As Range
    Set c = ws.Range("F5")

    If Not c.MergeCells Then
        IsRecipeSheet = False
        Exit Function
    End If

    Dim ma As Range
    Set ma = c.MergeArea

    ' 左上がF5、右下がAD5（完全一致を基本）
    If ma.Row <> 5 Or ma.Column <> ws.Range("F5").Column Then
        IsRecipeSheet = False
        Exit Function
    End If

    If ma.Columns.Count < (ws.Range("AD5").Column - ws.Range("F5").Column + 1) Then
        IsRecipeSheet = False
        Exit Function
    End If

    Dim menuName As String
    menuName = Trim(GetMergedText(c))
    If menuName = "" Then
        IsRecipeSheet = False
        Exit Function
    End If

    IsRecipeSheet = True
    Exit Function

NG:
    IsRecipeSheet = False
End Function

'========================================================
' 結合セルの左上値を取得
'========================================================
Private Function GetMergedText(ByVal rng As Range) As String
    If rng Is Nothing Then
        GetMergedText = ""
    ElseIf rng.MergeCells Then
        GetMergedText = CStr(rng.MergeArea.Cells(1, 1).Value)
    Else
        GetMergedText = CStr(rng.Value)
    End If
End Function

'========================================================
' シート取得 or 作成
' afterLast:=True なら末尾に作る
'========================================================
Private Function GetOrCreateSheet(ByVal wb As Workbook, ByVal sheetName As String, ByVal afterLast As Boolean) As Worksheet
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = wb.Worksheets(sheetName)
    On Error GoTo 0

    If ws Is Nothing Then
        If afterLast Then
            Set ws = wb.Worksheets.Add(After:=wb.Worksheets(wb.Worksheets.Count))
        Else
            Set ws = wb.Worksheets.Add(Before:=wb.Worksheets(1))
        End If
        ws.Name = sheetName
    End If

    Set GetOrCreateSheet = ws
End Function

'========================================================
' 表示用の見出し（無ければ作る）
'========================================================
Private Sub EnsureDisplayHeader(ByVal ws As Worksheet)
    If Trim(CStr(ws.Range("A1").Value)) = "" And Trim(CStr(ws.Range("B1").Value)) = "" Then
        ws.Range("A1").Value = "メニュー名"
        ws.Range("B1").Value = "区分"
        ws.Range("C1").Value = "食材名称"
        ws.Range("D1").Value = "使用量"
        ws.Range("E1").Value = "単位"
        ws.Range("F1").Value = "重量(g)"
    End If
End Sub

'========================================================
' 管理シートの見出し（無ければ作る）
'========================================================
Private Sub EnsureManageHeader(ByVal ws As Worksheet)
    If Trim(CStr(ws.Range("A1").Value)) = "" Then
        ws.Range("A1").Value = "処理済みシート名"
        ws.Range("B1").Value = "処理日時"
    End If
End Sub

'========================================================
' 管理シートから処理済み一覧を読み込む
'========================================================
Private Function LoadProcessedSheets(ByVal wsMng As Worksheet) As Object
    Dim dict As Object
    Set dict = CreateObject("Scripting.Dictionary")

    Dim lastRow As Long
    lastRow = wsMng.Cells(wsMng.Rows.Count, "A").End(xlUp).Row
    If lastRow < 2 Then
        Set LoadProcessedSheets = dict
        Exit Function
    End If

    Dim r As Long, nm As String
    For r = 2 To lastRow
        nm = Trim(CStr(wsMng.Cells(r, "A").Value))
        If nm <> "" Then
            If Not dict.Exists(nm) Then dict.Add nm, True
        End If
    Next r

    Set LoadProcessedSheets = dict
End Function

'========================================================
' 管理シートへ処理済みを追記
'========================================================
Private Sub AppendProcessedSheet(ByVal wsMng As Worksheet, ByVal sheetName As String)
    Dim r As Long
    r = wsMng.Cells(wsMng.Rows.Count, "A").End(xlUp).Row + 1
    If r < 2 Then r = 2
    wsMng.Cells(r, "A").Value = sheetName
    wsMng.Cells(r, "B").Value = Now
End Sub


                          
</code></pre>
</body>
</html>
