<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>VBA Code Share</title>
<style>
  body { font-family: Consolas, monospace; padding: 20px; }
  pre {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
  }
</style>
</head>
<body>
<h2>VBA Code</h2>
<pre><code>

Option Explicit

' 部門名称 5階層が変わったかどうか判定
Private Function DeptChanged(ByVal prevDept As Variant, ByVal curDept As Variant) As Boolean
    Dim i As Long
    DeptChanged = False
    
    If IsEmpty(prevDept) Or IsEmpty(curDept) Then
        DeptChanged = True
        Exit Function
    End If
    
    For i = 1 To 5
        If CStr(prevDept(i)) <> CStr(curDept(i)) Then
            DeptChanged = True
            Exit Function
        End If
    Next i
End Function

' 今月情報 or 先月情報シートから
' 社員番号ごとの 部門名称(5階層)・職位・氏名 を辞書に格納
' ★ A列が「丸亀製麺」以外の行は読み飛ばす
Private Sub LoadMonthData( _
        ByVal ws As Worksheet, _
        ByRef dictDept As Object, _
        ByRef dictTitle As Object, _
        ByRef dictName As Object)
    
    Dim lastRow As Long
    Dim r As Long
    Dim empNo As String
    Dim arrDept(1 To 5) As Variant
    Dim company As String
    
    Set dictDept = CreateObject("Scripting.Dictionary")
    Set dictTitle = CreateObject("Scripting.Dictionary")
    Set dictName = CreateObject("Scripting.Dictionary")
    
    ' ★ 社員番号の列（13列目）で最終行を判定
    lastRow = ws.Cells(ws.Rows.Count, 13).End(xlUp).Row
    If lastRow < 3 Then Exit Sub   ' データ無し
    
    For r = 3 To lastRow
        
        ' ★ 1列目が「丸亀製麺」以外ならスキップ
        company = CStr(ws.Cells(r, 1).Value)
        If company <> "丸亀製麺" Then
            GoTo NextRow
        End If
        
        empNo = Trim$(CStr(ws.Cells(r, 13).Value)) ' ★ 社員番号（13列目）
        
        If empNo <> "" Then
            ' ★ 部門名称（C,E,G,I,K → 3,5,7,9,11列）
            arrDept(1) = CStr(ws.Cells(r, 3).Value)   ' 第1階層_部門名称
            arrDept(2) = CStr(ws.Cells(r, 5).Value)   ' 第2階層_部門名称
            arrDept(3) = CStr(ws.Cells(r, 7).Value)   ' 第3階層_部門名称
            arrDept(4) = CStr(ws.Cells(r, 9).Value)   ' 第4階層_部門名称
            arrDept(5) = CStr(ws.Cells(r, 11).Value)  ' 第5階層_部門名称
            
            dictDept(empNo) = arrDept
            dictTitle(empNo) = CStr(ws.Cells(r, 12).Value) ' ★ 職位（12列目）
            dictName(empNo) = CStr(ws.Cells(r, 14).Value)  ' ★ 氏名（14列目）
        End If
        
NextRow:
    Next r
End Sub

' メイン：入退職者情報 ＋ 異動情報 を作成
Public Sub 入退職者_異動情報_作成()

    Dim wb As Workbook
    Dim wsCur As Worksheet  ' 今月情報
    Dim wsPrev As Worksheet ' 先月情報
    Dim wsInOut As Worksheet ' 入退職者情報
    Dim wsMove As Worksheet  ' 異動情報
    
    Dim dictCurDept As Object, dictCurTitle As Object, dictCurName As Object
    Dim dictPrevDept As Object, dictPrevTitle As Object, dictPrevName As Object
    
    Dim keys As Variant
    Dim empNo As String
    Dim arrDeptCur As Variant, arrDeptPrev As Variant
    Dim i As Long
    
    Dim rowNew As Long, rowLeave As Long, rowMove As Long
    
    On Error GoTo ErrHandler
    Application.ScreenUpdating = False
    
    Set wb = ThisWorkbook
    
    '----- 今月情報・先月情報 シート取得 -----
    On Error Resume Next
    Set wsCur = wb.Worksheets("今月情報")
    Set wsPrev = wb.Worksheets("先月情報")
    On Error GoTo ErrHandler
    
    If wsCur Is Nothing Then
        MsgBox "「今月情報」シートが見つかりません。", vbExclamation
        GoTo ExitPoint
    End If
    If wsPrev Is Nothing Then
        MsgBox "「先月情報」シートが見つかりません。", vbExclamation
        GoTo ExitPoint
    End If
    
    '----- データ読み込み（★ここで丸亀製麺だけに絞られる） -----
    LoadMonthData wsCur, dictCurDept, dictCurTitle, dictCurName
    LoadMonthData wsPrev, dictPrevDept, dictPrevTitle, dictPrevName
          
    '===============================
    '   入退職者情報 シートの作成
    '===============================
    On Error Resume Next
    Set wsInOut = wb.Worksheets("入退職者情報")
    On Error GoTo ErrHandler
    
    If wsInOut Is Nothing Then
        ' ★初回だけシート作成＆見出し・結合を設定
        Set wsInOut = wb.Worksheets.Add(After:=wb.Sheets(wb.Sheets.Count))
        wsInOut.Name = "入退職者情報"
        
        With wsInOut
            ' 見出し（1行目）
            .Range("A1:H1").Merge
            .Range("A1").Value = "新規入職者"
            .Range("J1:Q1").Merge
            .Range("J1").Value = "退職者"
            
            ' 2行目 見出し（新規入職者側）
            .Range("A2").Value = "第1階層_部門名称"
            .Range("B2").Value = "第2階層_部門名称"
            .Range("C2").Value = "第3階層_部門名称"
            .Range("D2").Value = "第4階層_部門名称"
            .Range("E2").Value = "第5階層_部門名称"
            .Range("F2").Value = "職位"
            .Range("G2").Value = "社員番号"
            .Range("H2").Value = "氏名"
            
            ' 2行目 見出し（退職者側）
            .Range("J2").Value = "第1階層_部門名称"
            .Range("K2").Value = "第2階層_部門名称"
            .Range("L2").Value = "第3階層_部門名称"
            .Range("M2").Value = "第4階層_部門名称"
            .Range("N2").Value = "第5階層_部門名称"
            .Range("O2").Value = "職位"
            .Range("P2").Value = "社員番号"
            .Range("Q2").Value = "氏名"
        End With
        
    Else
        ' ★2回目以降はデータ行だけ消す（3行目以降）
        With wsInOut
            .Range("A3:H" & .Rows.Count).ClearContents
            .Range("J3:Q" & .Rows.Count).ClearContents
        End With
    End If
    
    rowNew = 3
    rowLeave = 3

    '----- 新規入職者（今月にいて先月にいない） -----
    keys = dictCurDept.Keys
    For i = LBound(keys) To UBound(keys)
        empNo = CStr(keys(i))
        If Not dictPrevDept.Exists(empNo) Then
            arrDeptCur = dictCurDept(empNo)
            With wsInOut
                .Cells(rowNew, 1).Value = arrDeptCur(1)
                .Cells(rowNew, 2).Value = arrDeptCur(2)
                .Cells(rowNew, 3).Value = arrDeptCur(3)
                .Cells(rowNew, 4).Value = arrDeptCur(4)
                .Cells(rowNew, 5).Value = arrDeptCur(5)
                .Cells(rowNew, 6).Value = dictCurTitle(empNo)
                .Cells(rowNew, 7).Value = empNo
                .Cells(rowNew, 8).Value = dictCurName(empNo)
            End With
            rowNew = rowNew + 1
        End If
    Next i
    
    '----- 退職者（先月にいて今月にいない） -----
    keys = dictPrevDept.Keys
    For i = LBound(keys) To UBound(keys)
        empNo = CStr(keys(i))
        If Not dictCurDept.Exists(empNo) Then
            arrDeptPrev = dictPrevDept(empNo)
            With wsInOut
                .Cells(rowLeave, 10).Value = arrDeptPrev(1) ' J列
                .Cells(rowLeave, 11).Value = arrDeptPrev(2)
                .Cells(rowLeave, 12).Value = arrDeptPrev(3)
                .Cells(rowLeave, 13).Value = arrDeptPrev(4)
                .Cells(rowLeave, 14).Value = arrDeptPrev(5)
                .Cells(rowLeave, 15).Value = dictPrevTitle(empNo)
                .Cells(rowLeave, 16).Value = empNo
                .Cells(rowLeave, 17).Value = dictPrevName(empNo)
            End With
            rowLeave = rowLeave + 1
        End If
    Next i
    
    wsInOut.Columns("A:Q").EntireColumn.AutoFit
    
    '===============================
    '        異動情報 シート
    '===============================
    On Error Resume Next
    Set wsMove = wb.Worksheets("異動情報")
    On Error GoTo ErrHandler
    
    If wsMove Is Nothing Then
        ' ★初回だけシート作成＆見出し・結合を設定
        Set wsMove = wb.Worksheets.Add(After:=wb.Sheets(wb.Sheets.Count))
        wsMove.Name = "異動情報"
        
        With wsMove
            ' 1行目 見出し（大見出し）
            .Range("A1:E1").Merge
            .Range("A1").Value = "先月所属"
            .Range("F1:J1").Merge
            .Range("F1").Value = "今月所属"
            .Range("K1").Value = "職位"
            .Range("L1").Value = "社員番号"
            .Range("M1").Value = "氏名"
            
            ' 2行目 細かい見出し
            .Range("A2").Value = "第1階層_部門名称"
            .Range("B2").Value = "第2階層_部門名称"
            .Range("C2").Value = "第3階層_部門名称"
            .Range("D2").Value = "第4階層_部門名称"
            .Range("E2").Value = "第5階層_部門名称"
            
            .Range("F2").Value = "第1階層_部門名称"
            .Range("G2").Value = "第2階層_部門名称"
            .Range("H2").Value = "第3階層_部門名称"
            .Range("I2").Value = "第4階層_部門名称"
            .Range("J2").Value = "第5階層_部門名称"
            
            .Range("K2").Value = "職位"
            .Range("L2").Value = "社員番号"
            .Range("M2").Value = "氏名"
        End With
        
    Else
        ' ★2回目以降はデータ行だけ消す（3行目以降）
        With wsMove
            .Range("A3:M" & .Rows.Count).ClearContents
        End With
    End If
    
    rowMove = 3
    
    '----- 異動者（両方にいるが部門名称が変わった人） -----
    keys = dictCurDept.Keys
    For i = LBound(keys) To UBound(keys)
        empNo = CStr(keys(i))
        If dictPrevDept.Exists(empNo) Then
            arrDeptCur = dictCurDept(empNo)
            arrDeptPrev = dictPrevDept(empNo)
            
            If DeptChanged(arrDeptPrev, arrDeptCur) Then
                With wsMove
                    ' 先月所属
                    .Cells(rowMove, 1).Value = arrDeptPrev(1)
                    .Cells(rowMove, 2).Value = arrDeptPrev(2)
                    .Cells(rowMove, 3).Value = arrDeptPrev(3)
                    .Cells(rowMove, 4).Value = arrDeptPrev(4)
                    .Cells(rowMove, 5).Value = arrDeptPrev(5)
                    ' 今月所属
                    .Cells(rowMove, 6).Value = arrDeptCur(1)
                    .Cells(rowMove, 7).Value = arrDeptCur(2)
                    .Cells(rowMove, 8).Value = arrDeptCur(3)
                    .Cells(rowMove, 9).Value = arrDeptCur(4)
                    .Cells(rowMove, 10).Value = arrDeptCur(5)
                    ' 本人情報（今月の情報を採用）
                    .Cells(rowMove, 11).Value = dictCurTitle(empNo)
                    .Cells(rowMove, 12).Value = empNo
                    .Cells(rowMove, 13).Value = dictCurName(empNo)
                End With
                rowMove = rowMove + 1
            End If
        End If
    Next i
    
    wsMove.Columns("A:M").EntireColumn.AutoFit
    
    MsgBox "「入退職者情報」「異動情報」の作成が完了しました。", vbInformation

ExitPoint:
    Application.ScreenUpdating = True
    On Error GoTo 0
    Exit Sub

ErrHandler:
    MsgBox "エラーが発生しました。" & vbCrLf & _
           Err.Number & " : " & Err.Description, vbCritical
    Resume ExitPoint
End Sub

                          
</code></pre>
</body>
</html>
