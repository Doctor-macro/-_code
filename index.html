<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>VBA Code Share</title>
<style>
  body { font-family: Consolas, monospace; padding: 20px; }
  pre {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
  }
</style>
</head>
<body>
<h2>VBA Code</h2>
<pre><code>










Option Explicit

'========================================================
' 退職情報貼り付け：先月/今月の2ファイルを読み込み、値貼り付け
'========================================================
Public Sub 退職情報_先月今月_取込貼付()
    Const TARGET_SHEET As String = "退職情報貼り付け"
    Const SOURCE_SHEET As String = "管理店舗数"
    Const SRC_START_ROW As Long = 11
    
    ' 取り込む列（ソース側）
    Dim srcCols As Variant
    srcCols = Array(2, 3, 20, 21, 22) ' B, C, T, U, V
    
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual
    
    On Error GoTo EH
    
    Dim wsT As Worksheet
    Set wsT = ThisWorkbook.Worksheets(TARGET_SHEET)
    
    ' 1) 既存データ消去（B-F と J-N の3行目以降だけ）
    ClearTargetData wsT
    
    ' 2) 先月ファイル選択 → 読込 → B-F貼付
    Dim pathPrev As String, ymPrev As String
    pathPrev = PickExcelFile("先月の情報が含まれるファイルを選んでください")
    If pathPrev = "" Then GoTo SafeExit 'キャンセル
    
    ymPrev = ExtractYearMonthFromFilename(pathPrev)
    If ymPrev <> "" Then wsT.Range("B1").Value = ymPrev Else wsT.Range("B1").Value = "" '念のため
    
    ImportFromOneFile _
        filePath:=pathPrev, _
        sourceSheetName:=SOURCE_SHEET, _
        srcStartRow:=SRC_START_ROW, _
        srcColIndexes:=srcCols, _
        targetSheet:=wsT, _
        targetTopLeftCell:=wsT.Range("B3")
    
    ' 3) 今月ファイル選択 → 読込 → J-N貼付
    Dim pathNow As String, ymNow As String
    pathNow = PickExcelFile("今月の情報が含まれるファイルを選んでください")
    If pathNow = "" Then GoTo SafeExit 'キャンセル
    
    ymNow = ExtractYearMonthFromFilename(pathNow)
    If ymNow <> "" Then wsT.Range("J1").Value = ymNow Else wsT.Range("J1").Value = ""
    
    ImportFromOneFile _
        filePath:=pathNow, _
        sourceSheetName:=SOURCE_SHEET, _
        srcStartRow:=SRC_START_ROW, _
        srcColIndexes:=srcCols, _
        targetSheet:=wsT, _
        targetTopLeftCell:=wsT.Range("J3")
    
    MsgBox "取込が完了しました。" & vbCrLf & _
           "先月: " & IIf(ymPrev = "", "(年月抽出失敗)", ymPrev) & vbCrLf & _
           "今月: " & IIf(ymNow = "", "(年月抽出失敗)", ymNow), vbInformation
    
SafeExit:
    Application.ScreenUpdating = True
    Application.EnableEvents = True
    Application.Calculation = xlCalculationAutomatic
    Exit Sub

EH:
    MsgBox "エラーが発生しました: " & Err.Number & vbCrLf & Err.Description, vbExclamation
    Resume SafeExit
End Sub

'========================================================
' 対象シートの既存データ消去（B-F / J-N の3行目以降のみ）
'========================================================
Private Sub ClearTargetData(ByVal wsT As Worksheet)
    ' B-F (2-6), J-N (10-14)
    Dim lastRow As Long
    lastRow = wsT.Cells(wsT.Rows.Count, "B").End(xlUp).Row
    lastRow = Application.WorksheetFunction.Max(lastRow, wsT.Cells(wsT.Rows.Count, "J").End(xlUp).Row)
    If lastRow < 3 Then lastRow = 3
    
    wsT.Range("B3:F" & lastRow).ClearContents
    wsT.Range("J3:N" & lastRow).ClearContents
End Sub

'========================================================
' 1ファイル分の読込 → 値貼付（B,C,T,U,V を縦に揃えて出力）
'========================================================
Private Sub ImportFromOneFile( _
    ByVal filePath As String, _
    ByVal sourceSheetName As String, _
    ByVal srcStartRow As Long, _
    ByVal srcColIndexes As Variant, _
    ByVal targetSheet As Worksheet, _
    ByVal targetTopLeftCell As Range _
)
    Dim wbS As Workbook, wsS As Worksheet
    Set wbS = Workbooks.Open(Filename:=filePath, ReadOnly:=True, UpdateLinks:=0)
    On Error GoTo CloseAndRaise
    
    Set wsS = wbS.Worksheets(sourceSheetName)
    
    ' ソース最終行（B列基準。必要なら別列基準に変更可能）
    Dim lastRow As Long
    lastRow = wsS.Cells(wsS.Rows.Count, "B").End(xlUp).Row
    If lastRow < srcStartRow Then
        ' データなし → 何もしない
        GoTo CloseAndExit
    End If
    
    Dim rowCount As Long
    rowCount = lastRow - srcStartRow + 1
    
    ' 出力配列（行×5列）
    Dim outArr() As Variant
    ReDim outArr(1 To rowCount, 1 To 5)
    
    Dim i As Long, c As Long, colIndex As Long
    For c = 0 To 4
        colIndex = CLng(srcColIndexes(c))
        Dim v As Variant
        v = wsS.Range(wsS.Cells(srcStartRow, colIndex), wsS.Cells(lastRow, colIndex)).Value '縦配列
        
        For i = 1 To rowCount
            outArr(i, c + 1) = v(i, 1)
        Next i
    Next c
    
    ' 値貼付（関数を壊さないように、対象範囲だけ Value 代入）
    targetTopLeftCell.Resize(rowCount, 5).Value = outArr
    
CloseAndExit:
    wbS.Close SaveChanges:=False
    Exit Sub

CloseAndRaise:
    Dim eNum As Long, eDesc As String
    eNum = Err.Number: eDesc = Err.Description
    On Error Resume Next
    wbS.Close SaveChanges:=False
    On Error GoTo 0
    Err.Raise eNum, , eDesc
End Sub

'========================================================
' ファイル選択ダイアログ（Excelファイル）
'========================================================
Private Function PickExcelFile(ByVal titleText As String) As String
    Dim fd As FileDialog
    Set fd = Application.FileDialog(msoFileDialogFilePicker)
    
    With fd
        .Title = titleText
        .AllowMultiSelect = False
        .Filters.Clear
        .Filters.Add "Excel Files", "*.xlsx; *.xlsm; *.xls; *.xlsb"
        If .Show <> -1 Then
            PickExcelFile = ""
        Else
            PickExcelFile = .SelectedItems(1)
        End If
    End With
End Function

'========================================================
' パスからファイル名を取り、YYYY年M月を抽出（例: ☆2025年12月～～）
' 失敗時は空文字
'========================================================
Private Function ExtractYearMonthFromFilename(ByVal fullPath As String) As String
    Dim fn As String
    fn = Dir(fullPath)
    
    ' 正規表現: 4桁年 + "年" + 1-2桁月 + "月"
    Dim re As Object
    Set re = CreateObject("VBScript.RegExp")
    With re
        .Pattern = "(\d{4})年(\d{1,2})月"
        .IgnoreCase = True
        .Global = False
    End With
    
    If re.Test(fn) Then
        Dim m As Object
        Set m = re.Execute(fn)(0)
        ExtractYearMonthFromFilename = m.SubMatches(0) & "年" & CInt(m.SubMatches(1)) & "月"
    Else
        ExtractYearMonthFromFilename = ""
    End If
End Function


                          
</code></pre>
</body>
</html>
